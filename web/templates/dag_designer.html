{% extends "base.html" %}

{% block title %}DAG Designer - {{ app_name }} Compute Server{% endblock %}

{% block extra_css %}
<style>
    :root {
        --canvas-bg: #f0f2f5;
        --canvas-grid: #d8dce3;
        --panel-bg: #ffffff;
        --panel-border: #d1d5db;
        --accent-primary: #10b981;
        --accent-secondary: #3b82f6;
        --accent-warning: #f59e0b;
        --accent-danger: #ef4444;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --node-subscription: #059669;
        --node-publication: #dc2626;
        --node-calculation: #2563eb;
        --node-metronome: #7c3aed;
        --node-sink: #475569;
        --component-subscriber: #0d9488;
        --component-publisher: #ea580c;
        --component-calculator: #7c3aed;
        --component-transformer: #0891b2;
    }

    body {
        background: var(--canvas-bg);
        overflow: hidden;
    }

    .designer-container {
        display: flex;
        height: calc(100vh - 60px);
        margin-top: 0;
    }

    /* Left Palette Panel */
    .palette-panel {
        width: 260px;
        min-width: 260px;
        background: var(--panel-bg);
        border-right: 1px solid var(--panel-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    }

    .palette-header {
        padding: 12px 15px;
        border-bottom: 1px solid var(--panel-border);
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .palette-header h5 {
        margin: 0;
        color: var(--text-primary);
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .palette-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .palette-section {
        margin-bottom: 12px;
    }

    .palette-section-header {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 8px;
        transition: all 0.2s;
    }

    .palette-section-header:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .palette-section-header i {
        margin-right: 8px;
        font-size: 12px;
        color: var(--text-secondary);
        transition: transform 0.2s;
    }

    .palette-section-header.collapsed i {
        transform: rotate(-90deg);
    }

    .palette-section-header span {
        color: var(--text-primary);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .palette-items {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .palette-item {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        background: #fafafa;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        cursor: grab;
        transition: all 0.2s;
        color: var(--text-primary);
        font-size: 12px;
    }

    .palette-item:hover {
        background: #f3f4f6;
        border-color: var(--accent-primary);
        transform: translateX(3px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .palette-item:active {
        cursor: grabbing;
    }

    .palette-item .item-icon {
        width: 26px;
        height: 26px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        font-size: 11px;
        color: white;
    }

    .palette-item[data-type="SubscriptionNode"] .item-icon { background: var(--node-subscription); }
    .palette-item[data-type="PublicationNode"] .item-icon { background: var(--node-publication); }
    .palette-item[data-type="CalculationNode"] .item-icon { background: var(--node-calculation); }
    .palette-item[data-type="MetronomeNode"] .item-icon { background: var(--node-metronome); }
    .palette-item[data-type="SinkNode"] .item-icon { background: var(--node-sink); }

    .palette-item[data-category="subscriber"] .item-icon { background: var(--component-subscriber); }
    .palette-item[data-category="publisher"] .item-icon { background: var(--component-publisher); }
    .palette-item[data-category="calculator"] .item-icon { background: var(--component-calculator); }
    .palette-item[data-category="transformer"] .item-icon { background: var(--component-transformer); }

    /* Components List Panel */
    .components-list-panel {
        width: 220px;
        min-width: 220px;
        background: var(--panel-bg);
        border-right: 1px solid var(--panel-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .components-list-header {
        padding: 12px 15px;
        border-bottom: 1px solid var(--panel-border);
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .components-list-header h5 {
        margin: 0;
        color: var(--text-primary);
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .components-list-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .component-section {
        margin-bottom: 15px;
    }

    .component-section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        margin-bottom: 6px;
        padding: 4px 8px;
        background: #f8fafc;
        border-radius: 4px;
        font-weight: 600;
    }

    .component-section-title .count-badge {
        background: var(--accent-primary);
        color: white;
        padding: 1px 6px;
        border-radius: 10px;
        font-size: 9px;
    }

    .component-list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 8px;
        background: #fafafa;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        margin-bottom: 4px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .component-list-item:hover {
        background: #f0f9ff;
        border-color: var(--accent-secondary);
    }

    .component-list-item.selected {
        background: #dbeafe;
        border-color: var(--accent-secondary);
    }

    .component-list-item .item-name {
        color: var(--text-primary);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 130px;
    }

    .component-list-item .item-type {
        color: var(--text-muted);
        font-size: 9px;
    }

    .component-list-item .item-actions {
        display: flex;
        gap: 2px;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .component-list-item:hover .item-actions {
        opacity: 1;
    }

    .component-list-item .item-btn {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 3px;
        font-size: 10px;
    }

    .component-list-item .item-btn:hover {
        background: rgba(0,0,0,0.05);
    }

    .component-list-item .item-btn.delete:hover {
        color: var(--accent-danger);
    }

    .empty-component-list {
        color: var(--text-muted);
        font-size: 10px;
        text-align: center;
        padding: 8px;
        font-style: italic;
    }

    /* Canvas Area */
    .canvas-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .canvas-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 15px;
        background: var(--panel-bg);
        border-bottom: 1px solid var(--panel-border);
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }

    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .toolbar-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        color: var(--text-primary);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .toolbar-btn:hover {
        background: #f1f5f9;
        border-color: var(--accent-primary);
    }

    .toolbar-btn.primary {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
        color: white;
        font-weight: 500;
    }

    .toolbar-btn.primary:hover {
        background: #059669;
    }

    .toolbar-btn.danger {
        border-color: #fecaca;
        color: var(--accent-danger);
    }

    .toolbar-btn.danger:hover {
        background: #fef2f2;
        border-color: var(--accent-danger);
    }

    .toolbar-separator {
        width: 1px;
        height: 24px;
        background: var(--panel-border);
        margin: 0 4px;
    }

    .dag-name-input {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        padding: 6px 10px;
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 600;
        width: 220px;
    }

    .dag-name-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
    }

    /* Main Canvas */
    .canvas-wrapper {
        flex: 1;
        position: relative;
        overflow: hidden;
        background:
            linear-gradient(rgba(216,220,227,0.5) 1px, transparent 1px),
            linear-gradient(90deg, rgba(216,220,227,0.5) 1px, transparent 1px);
        background-size: 20px 20px;
        background-color: var(--canvas-bg);
    }

    #dag-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: default;
    }

    .canvas-node {
        position: absolute;
        min-width: 180px;
        background: var(--panel-bg);
        border: 2px solid var(--panel-border);
        border-radius: 8px;
        cursor: move;
        user-select: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: box-shadow 0.2s, border-color 0.2s;
        z-index: 10;
    }

    .canvas-node:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .canvas-node.selected {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(16,185,129,0.2), 0 4px 12px rgba(0,0,0,0.12);
    }

    .canvas-node.connecting {
        border-color: var(--accent-secondary);
    }

    .node-header {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        border-radius: 6px 6px 0 0;
        cursor: move;
    }

    .node-header .node-icon {
        width: 22px;
        height: 22px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        font-size: 10px;
        color: white;
    }

    .canvas-node[data-type="SubscriptionNode"] .node-header { background: linear-gradient(135deg, var(--node-subscription) 0%, #047857 100%); }
    .canvas-node[data-type="PublicationNode"] .node-header { background: linear-gradient(135deg, var(--node-publication) 0%, #b91c1c 100%); }
    .canvas-node[data-type="CalculationNode"] .node-header { background: linear-gradient(135deg, var(--node-calculation) 0%, #1d4ed8 100%); }
    .canvas-node[data-type="MetronomeNode"] .node-header { background: linear-gradient(135deg, var(--node-metronome) 0%, #6d28d9 100%); }
    .canvas-node[data-type="SinkNode"] .node-header { background: linear-gradient(135deg, var(--node-sink) 0%, #334155 100%); }

    .node-header .node-title {
        flex: 1;
        color: white;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .node-header .node-type-badge {
        font-size: 8px;
        padding: 2px 5px;
        background: rgba(255,255,255,0.25);
        border-radius: 3px;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .node-body {
        padding: 8px 10px;
        font-size: 10px;
        color: var(--text-secondary);
        background: #fafafa;
    }

    .node-info-row {
        display: flex;
        align-items: center;
        margin-bottom: 3px;
    }

    .node-info-row i {
        width: 14px;
        margin-right: 5px;
        opacity: 0.7;
        font-size: 9px;
    }

    /* Connection Ports */
    .node-ports {
        display: flex;
        justify-content: space-between;
        padding: 6px 10px 8px;
        background: #fafafa;
        border-radius: 0 0 6px 6px;
    }

    .port {
        width: 12px;
        height: 12px;
        background: var(--panel-border);
        border: 2px solid var(--panel-bg);
        border-radius: 50%;
        cursor: crosshair;
        transition: all 0.2s;
        position: relative;
    }

    .port:hover {
        transform: scale(1.3);
    }

    .port.input {
        background: var(--accent-secondary);
    }

    .port.output {
        background: var(--accent-primary);
    }

    .port.active {
        box-shadow: 0 0 0 4px rgba(16,185,129,0.3);
    }

    /* SVG Edges */
    #edges-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
    }

    .edge-path {
        fill: none;
        stroke: var(--accent-primary);
        stroke-width: 2;
        pointer-events: stroke;
        cursor: pointer;
        marker-end: url(#arrowhead);
    }

    .edge-path:hover {
        stroke-width: 4;
        stroke: var(--accent-warning);
        marker-end: url(#arrowhead-hover);
    }

    .edge-path.selected {
        stroke: var(--accent-secondary);
        stroke-width: 3;
        marker-end: url(#arrowhead-selected);
    }

    .edge-path.temp {
        stroke: var(--accent-secondary);
        stroke-dasharray: 5,5;
        marker-end: url(#arrowhead-temp);
    }

    .edge-label {
        font-size: 9px;
        fill: var(--text-secondary);
        pointer-events: none;
    }

    /* Right Properties Panel */
    .properties-panel {
        width: 300px;
        min-width: 300px;
        background: var(--panel-bg);
        border-left: 1px solid var(--panel-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: -2px 0 8px rgba(0,0,0,0.05);
    }

    .properties-header {
        padding: 12px 15px;
        border-bottom: 1px solid var(--panel-border);
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .properties-header h5 {
        margin: 0;
        color: var(--text-primary);
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .properties-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
    }

    .property-section {
        margin-bottom: 16px;
    }

    .property-section-title {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 600;
        padding-bottom: 4px;
        border-bottom: 1px solid #f1f5f9;
    }

    .property-group {
        margin-bottom: 10px;
    }

    .property-label {
        display: block;
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 4px;
        font-weight: 500;
    }

    .property-input, .property-select {
        width: 100%;
        padding: 7px 10px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        color: var(--text-primary);
        font-size: 12px;
    }

    .property-input:focus, .property-select:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
    }

    .property-select {
        cursor: pointer;
    }

    .property-textarea {
        width: 100%;
        min-height: 80px;
        padding: 8px 10px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        color: var(--text-primary);
        font-size: 11px;
        font-family: 'Consolas', 'Monaco', monospace;
        resize: vertical;
    }

    .property-textarea:focus {
        outline: none;
        border-color: var(--accent-primary);
    }

    .property-checkbox {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
    }

    .property-checkbox input[type="checkbox"] {
        width: 14px;
        height: 14px;
        accent-color: var(--accent-primary);
    }

    .property-checkbox label {
        font-size: 11px;
        color: var(--text-primary);
    }

    .property-btn {
        padding: 7px 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        color: var(--text-primary);
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .property-btn:hover {
        background: #f1f5f9;
    }

    .property-btn.danger {
        border-color: #fecaca;
        color: var(--accent-danger);
    }

    .property-btn.danger:hover {
        background: #fef2f2;
    }

    /* Combo Input (Text + Datalist) */
    .combo-input-wrapper {
        position: relative;
    }

    .combo-input {
        width: 100%;
        padding: 7px 10px;
        padding-right: 28px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        color: var(--text-primary);
        font-size: 12px;
    }

    .combo-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
    }

    .combo-input-icon {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 10px;
        pointer-events: none;
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: var(--text-secondary);
        padding: 20px;
    }

    .empty-state i {
        font-size: 40px;
        opacity: 0.3;
        margin-bottom: 12px;
        color: var(--text-muted);
    }

    .empty-state p {
        font-size: 12px;
        max-width: 180px;
        color: var(--text-muted);
    }

    /* Modals */
    .modal-content {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        color: var(--text-primary);
        border-radius: 10px;
    }

    .modal-header {
        border-bottom-color: var(--panel-border);
        padding: 15px 20px;
    }

    .modal-footer {
        border-top-color: var(--panel-border);
        padding: 12px 20px;
    }

    .modal-title {
        color: var(--text-primary);
        font-size: 16px;
        font-weight: 600;
    }

    .modal-body {
        padding: 20px;
    }

    /* JSON Preview */
    .json-preview {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 6px;
        padding: 15px;
        max-height: 400px;
        overflow: auto;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 11px;
        color: #e2e8f0;
        white-space: pre;
    }

    /* Status Bar */
    .status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px 15px;
        background: #f8fafc;
        border-top: 1px solid var(--panel-border);
        font-size: 10px;
        color: var(--text-secondary);
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--accent-primary);
    }

    .status-dot.warning { background: var(--accent-warning); }
    .status-dot.error { background: var(--accent-danger); }

    /* Zoom Controls */
    .zoom-controls {
        position: absolute;
        bottom: 15px;
        right: 15px;
        display: flex;
        flex-direction: column;
        gap: 3px;
        z-index: 100;
    }

    .zoom-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 5px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 12px;
    }

    .zoom-btn:hover {
        background: #f1f5f9;
        border-color: var(--accent-primary);
    }

    /* Minimap */
    .minimap {
        position: absolute;
        bottom: 15px;
        left: 15px;
        width: 160px;
        height: 100px;
        background: rgba(255,255,255,0.9);
        border: 1px solid var(--panel-border);
        border-radius: 6px;
        overflow: hidden;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .minimap-content {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .minimap-node {
        position: absolute;
        background: var(--accent-primary);
        opacity: 0.7;
        border-radius: 2px;
    }

    /* Context Menu */
    .context-menu {
        position: absolute;
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 6px;
        padding: 4px 0;
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        z-index: 1000;
        min-width: 150px;
        display: none;
    }

    .context-menu.show {
        display: block;
    }

    .context-menu-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 7px 12px;
        color: var(--text-primary);
        font-size: 12px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .context-menu-item:hover {
        background: #f1f5f9;
    }

    .context-menu-item.danger {
        color: var(--accent-danger);
    }

    .context-menu-separator {
        height: 1px;
        background: var(--panel-border);
        margin: 4px 0;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }

    /* Animations */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .connecting .port.output {
        animation: pulse 1s infinite;
    }

    /* Settings Row */
    .settings-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }

    /* Responsive */
    @media (max-width: 1400px) {
        .palette-panel { width: 220px; min-width: 220px; }
        .components-list-panel { width: 180px; min-width: 180px; }
        .properties-panel { width: 260px; min-width: 260px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="designer-container">
    <!-- Left Palette Panel -->
    <div class="palette-panel">
        <div class="palette-header">
            <h5><i class="bi bi-collection"></i> Components</h5>
        </div>
        <div class="palette-content">
            <!-- Nodes Section -->
            <div class="palette-section">
                <div class="palette-section-header" onclick="togglePaletteSection(this)">
                    <i class="bi bi-chevron-down"></i>
                    <span>Nodes</span>
                </div>
                <div class="palette-items">
                    <div class="palette-item" draggable="true" data-type="SubscriptionNode" data-category="node">
                        <div class="item-icon"><i class="bi bi-box-arrow-in-down"></i></div>
                        <span>Subscription</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="PublicationNode" data-category="node">
                        <div class="item-icon"><i class="bi bi-box-arrow-up"></i></div>
                        <span>Publication</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="CalculationNode" data-category="node">
                        <div class="item-icon"><i class="bi bi-calculator"></i></div>
                        <span>Calculation</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="MetronomeNode" data-category="node">
                        <div class="item-icon"><i class="bi bi-stopwatch"></i></div>
                        <span>Metronome</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="SinkNode" data-category="node">
                        <div class="item-icon"><i class="bi bi-sign-stop"></i></div>
                        <span>Sink</span>
                    </div>
                </div>
            </div>

            <!-- Subscribers Section -->
            <div class="palette-section">
                <div class="palette-section-header" onclick="togglePaletteSection(this)">
                    <i class="bi bi-chevron-down"></i>
                    <span>Subscribers</span>
                </div>
                <div class="palette-items" style="max-height: 280px; overflow-y: auto;">
                    <div class="palette-item" draggable="true" data-type="KafkaDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#059669;"><i class="bi bi-broadcast"></i></div>
                        <span>Kafka</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="RedisChannelDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#dc2626;"><i class="bi bi-database"></i></div>
                        <span>Redis Channel</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="RabbitMQDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#f97316;"><i class="bi bi-envelope"></i></div>
                        <span>RabbitMQ</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="ActiveMQDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#ea580c;"><i class="bi bi-envelope-open"></i></div>
                        <span>ActiveMQ</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="GRPCDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#8b5cf6;"><i class="bi bi-arrow-left-right"></i></div>
                        <span>gRPC</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="FileDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#0891b2;"><i class="bi bi-file-earmark-text"></i></div>
                        <span>File</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="InMemoryDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#0d9488;"><i class="bi bi-memory"></i></div>
                        <span>InMemory</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="InMemoryRedisDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#14b8a6;"><i class="bi bi-hdd-stack"></i></div>
                        <span>InMemory Redis</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="InMemoryRedisChannelDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#2dd4bf;"><i class="bi bi-hdd-network"></i></div>
                        <span>InMemory Redis Ch</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="AshRedisChannelDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#10b981;"><i class="bi bi-diagram-3"></i></div>
                        <span>AshRedis Channel</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="MetronomeDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#7c3aed;"><i class="bi bi-alarm"></i></div>
                        <span>Metronome</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="FaninDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#6366f1;"><i class="bi bi-arrows-collapse"></i></div>
                        <span>Fan-In (Composite)</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="FanoutDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#a855f7;"><i class="bi bi-signpost-split"></i></div>
                        <span>Fan-Out (Router)</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="CustomDataSubscriber" data-category="subscriber">
                        <div class="item-icon" style="background:#64748b;"><i class="bi bi-puzzle"></i></div>
                        <span>Custom</span>
                    </div>
                </div>
            </div>

            <!-- Publishers Section -->
            <div class="palette-section">
                <div class="palette-section-header" onclick="togglePaletteSection(this)">
                    <i class="bi bi-chevron-down"></i>
                    <span>Publishers</span>
                </div>
                <div class="palette-items" style="max-height: 280px; overflow-y: auto;">
                    <div class="palette-item" draggable="true" data-type="KafkaDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#dc2626;"><i class="bi bi-broadcast-pin"></i></div>
                        <span>Kafka</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="RedisDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#ef4444;"><i class="bi bi-database-add"></i></div>
                        <span>Redis</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="RedisChannelDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#f87171;"><i class="bi bi-database-up"></i></div>
                        <span>Redis Channel</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="RabbitMQDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#f97316;"><i class="bi bi-envelope-plus"></i></div>
                        <span>RabbitMQ</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="ActiveMQDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#fb923c;"><i class="bi bi-envelope-arrow-up"></i></div>
                        <span>ActiveMQ</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="GRPCDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#a78bfa;"><i class="bi bi-arrow-up-right"></i></div>
                        <span>gRPC</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="FileDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#0891b2;"><i class="bi bi-file-earmark-arrow-up"></i></div>
                        <span>File</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="InMemoryDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#0d9488;"><i class="bi bi-memory"></i></div>
                        <span>InMemory</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="InMemoryRedisDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#14b8a6;"><i class="bi bi-hdd-fill"></i></div>
                        <span>InMemory Redis</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="InMemoryRedisChannelDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#2dd4bf;"><i class="bi bi-hdd-rack-fill"></i></div>
                        <span>InMemory Redis Ch</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="AshRedisDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#10b981;"><i class="bi bi-diagram-2"></i></div>
                        <span>AshRedis</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="AshRedisChannelDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#34d399;"><i class="bi bi-diagram-3-fill"></i></div>
                        <span>AshRedis Channel</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="AerospikeDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#84cc16;"><i class="bi bi-cloud-upload"></i></div>
                        <span>Aerospike</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="MetronomeDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#7c3aed;"><i class="bi bi-stopwatch"></i></div>
                        <span>Metronome</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="FaninDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#6366f1;"><i class="bi bi-arrows-expand"></i></div>
                        <span>Fan-In (Composite)</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="FanoutDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#a855f7;"><i class="bi bi-signpost-2"></i></div>
                        <span>Fan-Out (Router)</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="CustomDataPublisher" data-category="publisher">
                        <div class="item-icon" style="background:#64748b;"><i class="bi bi-puzzle-fill"></i></div>
                        <span>Custom</span>
                    </div>
                </div>
            </div>

            <!-- Calculators Section -->
            <div class="palette-section">
                <div class="palette-section-header" onclick="togglePaletteSection(this)">
                    <i class="bi bi-chevron-down"></i>
                    <span>Calculators</span>
                </div>
                <div class="palette-items">
                    <div class="palette-item" draggable="true" data-type="PassthruCalculator" data-category="calculator">
                        <div class="item-icon"><i class="bi bi-arrow-right"></i></div>
                        <span>Passthru</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="ApplyDefaultsCalculator" data-category="calculator">
                        <div class="item-icon"><i class="bi bi-plus-square"></i></div>
                        <span>Apply Defaults</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="AdditionCalculator" data-category="calculator">
                        <div class="item-icon"><i class="bi bi-plus-lg"></i></div>
                        <span>Addition</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="MultiplicationCalculator" data-category="calculator">
                        <div class="item-icon"><i class="bi bi-x-lg"></i></div>
                        <span>Multiplication</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="AttributeFilterCalculator" data-category="calculator">
                        <div class="item-icon"><i class="bi bi-funnel"></i></div>
                        <span>Attribute Filter</span>
                    </div>
                </div>
            </div>

            <!-- Transformers Section -->
            <div class="palette-section">
                <div class="palette-section-header" onclick="togglePaletteSection(this)">
                    <i class="bi bi-chevron-down"></i>
                    <span>Transformers</span>
                </div>
                <div class="palette-items">
                    <div class="palette-item" draggable="true" data-type="PassthruDataTransformer" data-category="transformer">
                        <div class="item-icon"><i class="bi bi-arrow-right"></i></div>
                        <span>Passthru</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="AttributeFilterDataTransformer" data-category="transformer">
                        <div class="item-icon"><i class="bi bi-funnel"></i></div>
                        <span>Attribute Filter</span>
                    </div>
                    <div class="palette-item" draggable="true" data-type="ApplyDefaultsDataTransformer" data-category="transformer">
                        <div class="item-icon"><i class="bi bi-plus-square"></i></div>
                        <span>Apply Defaults</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Components List Panel -->
    <div class="components-list-panel">
        <div class="components-list-header">
            <h5><i class="bi bi-list-ul"></i> Defined</h5>
        </div>
        <div class="components-list-content">
            <!-- Subscribers List -->
            <div class="component-section">
                <div class="component-section-title">
                    <span><i class="bi bi-inbox"></i> Subscribers</span>
                    <span class="count-badge" id="subscriberCount">0</span>
                </div>
                <div id="subscribersList"></div>
            </div>

            <!-- Publishers List -->
            <div class="component-section">
                <div class="component-section-title">
                    <span><i class="bi bi-broadcast"></i> Publishers</span>
                    <span class="count-badge" id="publisherCount">0</span>
                </div>
                <div id="publishersList"></div>
            </div>

            <!-- Calculators List -->
            <div class="component-section">
                <div class="component-section-title">
                    <span><i class="bi bi-calculator"></i> Calculators</span>
                    <span class="count-badge" id="calculatorCount">0</span>
                </div>
                <div id="calculatorsList"></div>
            </div>

            <!-- Transformers List -->
            <div class="component-section">
                <div class="component-section-title">
                    <span><i class="bi bi-shuffle"></i> Transformers</span>
                    <span class="count-badge" id="transformerCount">0</span>
                </div>
                <div id="transformersList"></div>
            </div>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div class="canvas-container">
        <div class="canvas-toolbar">
            <div class="toolbar-group">
                <input type="text" class="dag-name-input" id="dagName" placeholder="Enter DAG name..." value="">
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn" onclick="showDagSettings()" title="DAG Settings">
                    <i class="bi bi-gear"></i> Settings
                </button>
            </div>
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="loadFromFile()" title="Import JSON">
                    <i class="bi bi-upload"></i> Import
                </button>
                <button class="toolbar-btn" onclick="exportToFile()" title="Export JSON">
                    <i class="bi bi-download"></i> Export
                </button>
                <div class="toolbar-separator"></div>
                <select class="property-select" id="loadExistingDag" style="width: 160px; padding: 6px 8px;" onchange="loadExistingDag(this.value)">
                    <option value="">Load Existing...</option>
                    {% for dag in existing_dags %}
                    <option value="{{ dag }}">{{ dag }}</option>
                    {% endfor %}
                </select>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn" onclick="validateDag()" title="Validate DAG">
                    <i class="bi bi-check-circle"></i> Validate
                </button>
                <button class="toolbar-btn" onclick="previewJson()" title="Preview JSON">
                    <i class="bi bi-code-slash"></i> Preview
                </button>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn danger" onclick="clearCanvas()" title="Clear Canvas">
                    <i class="bi bi-trash"></i> Clear
                </button>
            </div>
        </div>

        <div class="canvas-wrapper" id="canvasWrapper">
            <svg id="edges-svg">
                <defs>
                    <!-- Arrowhead marker for normal edges -->
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
                    </marker>
                    <!-- Arrowhead marker for hovered edges -->
                    <marker id="arrowhead-hover" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/>
                    </marker>
                    <!-- Arrowhead marker for selected edges -->
                    <marker id="arrowhead-selected" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                    </marker>
                    <!-- Arrowhead marker for temp edges -->
                    <marker id="arrowhead-temp" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                    </marker>
                </defs>
            </svg>
            <div id="dag-canvas"></div>

            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
                <button class="zoom-btn" onclick="resetZoom()" title="Reset"><i class="bi bi-aspect-ratio"></i></button>
                <button class="zoom-btn" onclick="fitToCanvas()" title="Fit"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>

            <div class="minimap" id="minimap">
                <div class="minimap-content" id="minimapContent"></div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Ready</span>
            </div>
            <div class="status-item">
                <span>Nodes: <strong id="nodeCount">0</strong></span>
                <span style="margin-left: 12px;">Edges: <strong id="edgeCount">0</strong></span>
                <span style="margin-left: 12px;">Zoom: <strong id="zoomLevel">100%</strong></span>
            </div>
        </div>
    </div>

    <!-- Right Properties Panel -->
    <div class="properties-panel">
        <div class="properties-header">
            <h5><i class="bi bi-sliders"></i> Properties</h5>
        </div>
        <div class="properties-content" id="propertiesContent">
            <div class="empty-state" id="emptyState">
                <i class="bi bi-hand-index"></i>
                <p>Select a node, edge, or component to edit its properties</p>
            </div>

            <!-- Node Properties -->
            <div id="nodeProperties" style="display: none;">
                <div class="property-section">
                    <div class="property-section-title">Node Configuration</div>
                    <div class="property-group">
                        <label class="property-label">Node Name</label>
                        <input type="text" class="property-input" id="propNodeName" onchange="updateSelectedNodeProperty('name', this.value)">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Node Type <small>(select or type custom)</small></label>
                        <div class="combo-input-wrapper">
                            <input type="text" class="combo-input" id="propNodeType" list="nodeTypeList" onchange="updateSelectedNodeProperty('type', this.value)">
                            <i class="bi bi-chevron-down combo-input-icon"></i>
                        </div>
                        <datalist id="nodeTypeList">
                            <option value="SubscriptionNode">
                            <option value="PublicationNode">
                            <option value="CalculationNode">
                            <option value="MetronomeNode">
                            <option value="SinkNode">
                            <option value="PublisherSinkNode">
                        </datalist>
                    </div>
                </div>

                <div class="property-section" id="subscriberSection" style="display: none;">
                    <div class="property-section-title">Subscriber</div>
                    <div class="property-group">
                        <label class="property-label">Select Subscriber</label>
                        <select class="property-select" id="propSubscriber" onchange="updateSelectedNodeProperty('subscriber', this.value)">
                            <option value="">-- Select Subscriber --</option>
                        </select>
                    </div>
                </div>

                <div class="property-section" id="publishersSection" style="display: none;">
                    <div class="property-section-title">Publishers</div>
                    <div class="property-group">
                        <label class="property-label">Select Publishers</label>
                        <div id="publisherCheckboxes"></div>
                    </div>
                </div>

                <div class="property-section" id="calculatorSection">
                    <div class="property-section-title">Calculator</div>
                    <div class="property-group">
                        <label class="property-label">Calculator <small>(select or type custom)</small></label>
                        <div class="combo-input-wrapper">
                            <input type="text" class="combo-input" id="propCalculator" list="calculatorList" onchange="updateSelectedNodeProperty('calculator', this.value || null)">
                            <i class="bi bi-chevron-down combo-input-icon"></i>
                        </div>
                        <datalist id="calculatorList"></datalist>
                    </div>
                </div>

                <div class="property-section" id="transformersSection">
                    <div class="property-section-title">Transformers</div>
                    <div class="property-group">
                        <label class="property-label">Input Transformers</label>
                        <div id="inputTransformerCheckboxes"></div>
                    </div>
                    <div class="property-group">
                        <label class="property-label">Output Transformers</label>
                        <div id="outputTransformerCheckboxes"></div>
                    </div>
                </div>

                <div class="property-section" id="metronomeSection" style="display: none;">
                    <div class="property-section-title">Metronome Settings</div>
                    <div class="property-group">
                        <label class="property-label">Interval (seconds)</label>
                        <input type="number" class="property-input" id="propInterval" min="1" value="60" onchange="updateSelectedNodeConfig('interval', parseInt(this.value))">
                    </div>
                </div>

                <div class="property-section">
                    <div class="property-section-title">Custom Config (JSON)</div>
                    <div class="property-group">
                        <textarea class="property-textarea" id="propConfig" placeholder='{"key": "value"}' onchange="updateSelectedNodeConfig(null, this.value)"></textarea>
                    </div>
                </div>

                <div class="property-section">
                    <button class="property-btn danger" onclick="deleteSelectedNode()" style="width: 100%;">
                        <i class="bi bi-trash"></i> Delete Node
                    </button>
                </div>
            </div>

            <!-- Edge Properties -->
            <div id="edgeProperties" style="display: none;">
                <div class="property-section">
                    <div class="property-section-title">Edge Configuration</div>
                    <div class="property-group">
                        <label class="property-label">From Node</label>
                        <input type="text" class="property-input" id="propEdgeFrom" readonly style="background: #f1f5f9;">
                    </div>
                    <div class="property-group">
                        <label class="property-label">To Node</label>
                        <input type="text" class="property-input" id="propEdgeTo" readonly style="background: #f1f5f9;">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Edge Name (pname)</label>
                        <input type="text" class="property-input" id="propEdgePname" placeholder="Optional pseudoname" onchange="updateSelectedEdgeProperty('pname', this.value)">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Data Transformer <small>(select or type custom)</small></label>
                        <div class="combo-input-wrapper">
                            <input type="text" class="combo-input" id="propEdgeTransformer" list="edgeTransformerList" onchange="updateSelectedEdgeProperty('data_transformer', this.value || null)">
                            <i class="bi bi-chevron-down combo-input-icon"></i>
                        </div>
                        <datalist id="edgeTransformerList"></datalist>
                    </div>
                </div>

                <div class="property-section">
                    <button class="property-btn danger" onclick="deleteSelectedEdge()" style="width: 100%;">
                        <i class="bi bi-trash"></i> Delete Edge
                    </button>
                </div>
            </div>

            <!-- Component Properties -->
            <div id="componentProperties" style="display: none;">
                <div class="property-section">
                    <div class="property-section-title" id="componentTypeTitle">Component Configuration</div>
                    <div class="property-group">
                        <label class="property-label">Name</label>
                        <input type="text" class="property-input" id="propComponentName" onchange="updateSelectedComponent('name', this.value)">
                    </div>
                    <div class="property-group" id="componentTypeGroup">
                        <label class="property-label">Type <small>(select or type custom)</small></label>
                        <div class="combo-input-wrapper">
                            <input type="text" class="combo-input" id="propComponentType" list="componentTypeList" onchange="updateSelectedComponent('type', this.value)">
                            <i class="bi bi-chevron-down combo-input-icon"></i>
                        </div>
                        <datalist id="componentTypeList"></datalist>
                    </div>
                </div>

                <div class="property-section">
                    <div class="property-section-title">Configuration (JSON)</div>
                    <div class="property-group">
                        <textarea class="property-textarea" id="propComponentConfig" placeholder='{"key": "value"}' onchange="updateSelectedComponentConfig(this.value)"></textarea>
                    </div>
                </div>

                <div class="property-section">
                    <button class="property-btn danger" onclick="deleteSelectedComponent()" style="width: 100%;">
                        <i class="bi bi-trash"></i> Delete Component
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="duplicateNode()"><i class="bi bi-copy"></i> Duplicate</div>
    <div class="context-menu-item" onclick="connectFromNode()"><i class="bi bi-link"></i> Connect From</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item danger" onclick="deleteSelectedNode()"><i class="bi bi-trash"></i> Delete</div>
</div>

<!-- DAG Settings Modal -->
<div class="modal fade" id="dagSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gear"></i> DAG Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="property-section">
                            <div class="property-section-title">Time Window</div>
                            <div class="property-group">
                                <label class="property-label">Start Time (HHMM)</label>
                                <input type="text" class="property-input" id="settingsStartTime" placeholder="e.g., 0800">
                            </div>
                            <div class="property-group">
                                <label class="property-label">Duration</label>
                                <input type="text" class="property-input" id="settingsDuration" placeholder="e.g., 8h, 1h30m">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="property-section">
                            <div class="property-section-title">Auto Clone</div>
                            <div class="property-group">
                                <div class="property-checkbox">
                                    <input type="checkbox" id="settingsAutocloneEnabled" onchange="toggleAutocloneSettings()">
                                    <label for="settingsAutocloneEnabled">Enable Auto Clone</label>
                                </div>
                            </div>
                            <div id="autocloneSettings" style="display: none;">
                                <div class="property-group">
                                    <label class="property-label">Ramp Up Time (HHMM)</label>
                                    <input type="text" class="property-input" id="settingsRampUpTime" placeholder="e.g., 1000">
                                </div>
                                <div class="property-group">
                                    <label class="property-label">Clone Duration</label>
                                    <input type="text" class="property-input" id="settingsCloneDuration" placeholder="e.g., 10m">
                                </div>
                                <div class="property-group">
                                    <label class="property-label">Ramp Count</label>
                                    <input type="number" class="property-input" id="settingsRampCount" min="1" value="5">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDagSettings()">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- JSON Preview Modal -->
<div class="modal fade" id="jsonPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-code-slash"></i> JSON Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="json-preview" id="jsonPreviewContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" onclick="copyJsonToClipboard()">
                    <i class="bi bi-clipboard"></i> Copy
                </button>
                <button type="button" class="btn btn-primary" onclick="exportToFile()">
                    <i class="bi bi-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Validation Modal -->
<div class="modal fade" id="validationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationTitle"><i class="bi bi-check-circle"></i> Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="validationContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

{% endblock %}

{% block extra_js %}
<script>
// ==========================================
// DAG Designer State
// ==========================================
const dagState = {
    name: '',
    start_time: null,
    duration: null,
    autoclone: null,
    subscribers: [],
    publishers: [],
    calculators: [],
    transformers: [],
    nodes: [],
    edges: []
};

let canvasState = {
    zoom: 1,
    panX: 0,
    panY: 0,
    selectedNode: null,
    selectedEdge: null,
    selectedComponent: null,
    selectedComponentType: null,
    connectingFrom: null,
    nodeCounter: 0,
    isDragging: false,
    dragNode: null,
    dragStartX: 0,
    dragStartY: 0,
    nodeStartX: 0,
    nodeStartY: 0
};

// ==========================================
// Initialization
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    initializeCanvas();
    initializeDragAndDrop();

    {% if loaded_dag %}
    const loadedDag = {{ loaded_dag|safe }};
    importDagJson(loadedDag);
    document.getElementById('dagName').value = loadedDag.name || '';
    {% endif %}

    updateStatusBar();
    updateComponentsLists();
});

function initializeCanvas() {
    const canvas = document.getElementById('dag-canvas');

    canvas.addEventListener('click', function(e) {
        if (e.target === canvas) {
            deselectAll();
        }
    });

    canvas.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        hideContextMenu();
    });

    document.getElementById('edges-svg').addEventListener('click', function(e) {
        if (e.target.classList.contains('edge-path')) {
            e.stopPropagation();
            const edgeIndex = parseInt(e.target.dataset.index);
            selectEdge(edgeIndex);
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Delete' || e.key === 'Backspace') {
            if (!isInputFocused()) {
                e.preventDefault();
                if (canvasState.selectedNode) deleteSelectedNode();
                else if (canvasState.selectedEdge !== null) deleteSelectedEdge();
            }
        }
        if (e.key === 'Escape') {
            cancelConnection();
            hideContextMenu();
        }
    });
}

function isInputFocused() {
    const active = document.activeElement;
    return active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'SELECT';
}

// ==========================================
// Drag and Drop
// ==========================================
function initializeDragAndDrop() {
    const paletteItems = document.querySelectorAll('.palette-item');
    const canvas = document.getElementById('dag-canvas');

    paletteItems.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
    });

    canvas.addEventListener('dragover', handleDragOver);
    canvas.addEventListener('drop', handleDrop);
}

function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', JSON.stringify({
        type: e.target.dataset.type,
        category: e.target.dataset.category
    }));
    e.target.style.opacity = '0.5';
}

function handleDragEnd(e) {
    e.target.style.opacity = '1';
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
}

function handleDrop(e) {
    e.preventDefault();
    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
    const canvas = document.getElementById('dag-canvas');
    const rect = canvas.getBoundingClientRect();

    const x = (e.clientX - rect.left) / canvasState.zoom;
    const y = (e.clientY - rect.top) / canvasState.zoom;

    if (data.category === 'node') {
        createNode(data.type, x, y);
    } else {
        createComponent(data.type, data.category);
    }
}

// ==========================================
// Node Management
// ==========================================
function createNode(type, x, y) {
    canvasState.nodeCounter++;
    const nodeId = `node_${canvasState.nodeCounter}`;

    const node = {
        id: nodeId,
        name: `${type.replace('Node', '').toLowerCase()}_${canvasState.nodeCounter}`,
        type: type,
        config: {},
        x: x,
        y: y
    };

    if (type === 'MetronomeNode') {
        node.config.interval = 60;
    }

    dagState.nodes.push(node);
    renderNode(node);
    selectNode(nodeId);
    updateStatusBar();
    updateMinimap();
}

function renderNode(node) {
    const canvas = document.getElementById('dag-canvas');

    const nodeEl = document.createElement('div');
    nodeEl.className = 'canvas-node';
    nodeEl.id = node.id;
    nodeEl.dataset.type = node.type;
    nodeEl.style.left = `${node.x}px`;
    nodeEl.style.top = `${node.y}px`;

    const subscriberInfo = node.subscriber ? `<div class="node-info-row"><i class="bi bi-inbox"></i>${node.subscriber}</div>` : '';
    const calculatorInfo = node.calculator ? `<div class="node-info-row"><i class="bi bi-calculator"></i>${node.calculator}</div>` : '';
    const publishersInfo = node.publishers && node.publishers.length > 0 ?
        `<div class="node-info-row"><i class="bi bi-broadcast"></i>${node.publishers.length} pub(s)</div>` : '';

    nodeEl.innerHTML = `
        <div class="node-header">
            <div class="node-icon"><i class="bi bi-${getNodeIcon(node.type)}"></i></div>
            <span class="node-title">${node.name}</span>
            <span class="node-type-badge">${node.type.replace('Node', '')}</span>
        </div>
        <div class="node-body">
            ${subscriberInfo}${calculatorInfo}${publishersInfo}
        </div>
        <div class="node-ports">
            <div class="port input" data-port="input" title="Input"></div>
            <div class="port output" data-port="output" title="Output"></div>
        </div>
    `;

    nodeEl.addEventListener('mousedown', handleNodeMouseDown);
    nodeEl.addEventListener('click', function(e) {
        e.stopPropagation();
        selectNode(node.id);
    });
    nodeEl.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        e.stopPropagation();
        selectNode(node.id);
        showContextMenu(e.clientX, e.clientY);
    });

    const outputPort = nodeEl.querySelector('.port.output');
    const inputPort = nodeEl.querySelector('.port.input');

    outputPort.addEventListener('mousedown', function(e) {
        e.stopPropagation();
        startConnection(node.id);
    });

    inputPort.addEventListener('mouseup', function(e) {
        e.stopPropagation();
        endConnection(node.id);
    });

    canvas.appendChild(nodeEl);
}

function getNodeIcon(type) {
    const icons = {
        'SubscriptionNode': 'box-arrow-in-down',
        'PublicationNode': 'box-arrow-up',
        'CalculationNode': 'calculator',
        'MetronomeNode': 'stopwatch',
        'SinkNode': 'sign-stop',
        'PublisherSinkNode': 'sign-stop'
    };
    return icons[type] || 'circle';
}

function updateNodeDisplay(nodeId) {
    const nodeEl = document.getElementById(nodeId);
    const node = dagState.nodes.find(n => n.id === nodeId);

    if (nodeEl && node) {
        nodeEl.querySelector('.node-title').textContent = node.name;
        nodeEl.querySelector('.node-type-badge').textContent = node.type.replace('Node', '');
        nodeEl.dataset.type = node.type;

        let bodyHtml = '';
        if (node.subscriber) bodyHtml += `<div class="node-info-row"><i class="bi bi-inbox"></i>${node.subscriber}</div>`;
        if (node.calculator) bodyHtml += `<div class="node-info-row"><i class="bi bi-calculator"></i>${node.calculator}</div>`;
        if (node.publishers && node.publishers.length > 0) bodyHtml += `<div class="node-info-row"><i class="bi bi-broadcast"></i>${node.publishers.length} pub(s)</div>`;
        nodeEl.querySelector('.node-body').innerHTML = bodyHtml;
    }
}

// ==========================================
// Node Dragging
// ==========================================
function handleNodeMouseDown(e) {
    if (e.target.classList.contains('port')) return;

    const nodeEl = e.currentTarget;
    canvasState.isDragging = true;
    canvasState.dragNode = nodeEl;
    canvasState.dragStartX = e.clientX;
    canvasState.dragStartY = e.clientY;
    canvasState.nodeStartX = parseInt(nodeEl.style.left);
    canvasState.nodeStartY = parseInt(nodeEl.style.top);

    document.addEventListener('mousemove', handleNodeDrag);
    document.addEventListener('mouseup', handleNodeDragEnd);
}

function handleNodeDrag(e) {
    if (!canvasState.isDragging || !canvasState.dragNode) return;

    const dx = (e.clientX - canvasState.dragStartX) / canvasState.zoom;
    const dy = (e.clientY - canvasState.dragStartY) / canvasState.zoom;

    const newX = Math.max(0, canvasState.nodeStartX + dx);
    const newY = Math.max(0, canvasState.nodeStartY + dy);

    canvasState.dragNode.style.left = `${newX}px`;
    canvasState.dragNode.style.top = `${newY}px`;

    const node = dagState.nodes.find(n => n.id === canvasState.dragNode.id);
    if (node) {
        node.x = newX;
        node.y = newY;
    }

    renderEdges();
    updateMinimap();
}

function handleNodeDragEnd(e) {
    canvasState.isDragging = false;
    canvasState.dragNode = null;
    document.removeEventListener('mousemove', handleNodeDrag);
    document.removeEventListener('mouseup', handleNodeDragEnd);
}

// ==========================================
// Edge Management
// ==========================================
function startConnection(fromNodeId) {
    canvasState.connectingFrom = fromNodeId;
    document.getElementById(fromNodeId).classList.add('connecting');

    document.addEventListener('mousemove', handleConnectionDrag);
    document.addEventListener('mouseup', cancelConnection);

    setStatus('Click target node input port to connect', 'warning');
}

function handleConnectionDrag(e) {
    if (!canvasState.connectingFrom) return;

    const svg = document.getElementById('edges-svg');
    const wrapper = document.getElementById('canvasWrapper');
    const rect = wrapper.getBoundingClientRect();

    const fromNode = document.getElementById(canvasState.connectingFrom);
    const fromPort = fromNode.querySelector('.port.output');
    const fromRect = fromPort.getBoundingClientRect();

    const x1 = (fromRect.left + fromRect.width/2 - rect.left) / canvasState.zoom;
    const y1 = (fromRect.top + fromRect.height/2 - rect.top) / canvasState.zoom;
    const x2 = (e.clientX - rect.left) / canvasState.zoom;
    const y2 = (e.clientY - rect.top) / canvasState.zoom;

    let tempEdge = svg.querySelector('.edge-path.temp');
    if (!tempEdge) {
        tempEdge = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        tempEdge.classList.add('edge-path', 'temp');
        svg.appendChild(tempEdge);
    }

    tempEdge.setAttribute('d', createEdgePath(x1, y1, x2, y2));
}

function endConnection(toNodeId) {
    if (!canvasState.connectingFrom || canvasState.connectingFrom === toNodeId) {
        cancelConnection();
        return;
    }

    const exists = dagState.edges.some(e =>
        e._fromId === canvasState.connectingFrom && e._toId === toNodeId
    );

    if (!exists) {
        const fromNode = dagState.nodes.find(n => n.id === canvasState.connectingFrom);
        const toNode = dagState.nodes.find(n => n.id === toNodeId);

        dagState.edges.push({
            from_node: fromNode.name,
            to_node: toNode.name,
            pname: '',
            data_transformer: null,
            _fromId: canvasState.connectingFrom,
            _toId: toNodeId
        });

        renderEdges();
        updateStatusBar();
    }

    cancelConnection();
}

function cancelConnection() {
    if (canvasState.connectingFrom) {
        document.getElementById(canvasState.connectingFrom).classList.remove('connecting');
    }
    canvasState.connectingFrom = null;

    const tempEdge = document.querySelector('.edge-path.temp');
    if (tempEdge) tempEdge.remove();

    document.removeEventListener('mousemove', handleConnectionDrag);
    document.removeEventListener('mouseup', cancelConnection);

    setStatus('Ready');
}

function renderEdges() {
    const svg = document.getElementById('edges-svg');

    svg.querySelectorAll('.edge-path:not(.temp)').forEach(e => e.remove());
    svg.querySelectorAll('.edge-label').forEach(e => e.remove());

    dagState.edges.forEach((edge, index) => {
        let fromNodeEl, toNodeEl;

        if (edge._fromId && edge._toId) {
            fromNodeEl = document.getElementById(edge._fromId);
            toNodeEl = document.getElementById(edge._toId);
        } else {
            const fromNode = dagState.nodes.find(n => n.name === edge.from_node);
            const toNode = dagState.nodes.find(n => n.name === edge.to_node);
            if (fromNode && toNode) {
                fromNodeEl = document.getElementById(fromNode.id);
                toNodeEl = document.getElementById(toNode.id);
                edge._fromId = fromNode.id;
                edge._toId = toNode.id;
            }
        }

        if (!fromNodeEl || !toNodeEl) return;

        const x1 = parseInt(fromNodeEl.style.left) + fromNodeEl.offsetWidth - 10;
        const y1 = parseInt(fromNodeEl.style.top) + fromNodeEl.offsetHeight - 14;
        const x2 = parseInt(toNodeEl.style.left) + 10;
        const y2 = parseInt(toNodeEl.style.top) + toNodeEl.offsetHeight - 14;

        const pathEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        pathEl.classList.add('edge-path');
        if (canvasState.selectedEdge === index) pathEl.classList.add('selected');
        pathEl.dataset.index = index;
        pathEl.setAttribute('d', createEdgePath(x1, y1, x2, y2));
        pathEl.style.pointerEvents = 'stroke';

        svg.appendChild(pathEl);

        // Add label if edge has pname or transformer
        if (edge.pname || edge.data_transformer) {
            const midX = (x1 + x2) / 2;
            const midY = (y1 + y2) / 2 - 8;
            const labelText = edge.pname || edge.data_transformer || '';

            const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textEl.classList.add('edge-label');
            textEl.setAttribute('x', midX);
            textEl.setAttribute('y', midY);
            textEl.setAttribute('text-anchor', 'middle');
            textEl.textContent = labelText.length > 15 ? labelText.substr(0, 15) + '...' : labelText;

            svg.appendChild(textEl);
        }
    });
}

function createEdgePath(x1, y1, x2, y2) {
    const dx = Math.abs(x2 - x1);
    const controlOffset = Math.min(dx * 0.5, 80);
    return `M ${x1} ${y1} C ${x1 + controlOffset} ${y1}, ${x2 - controlOffset} ${y2}, ${x2} ${y2}`;
}

function selectEdge(index) {
    deselectAll();
    canvasState.selectedEdge = index;

    renderEdges();
    showEdgeProperties(index);
}

function showEdgeProperties(index) {
    const edge = dagState.edges[index];
    if (!edge) return;

    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('nodeProperties').style.display = 'none';
    document.getElementById('componentProperties').style.display = 'none';
    document.getElementById('edgeProperties').style.display = 'block';

    document.getElementById('propEdgeFrom').value = edge.from_node;
    document.getElementById('propEdgeTo').value = edge.to_node;
    document.getElementById('propEdgePname').value = edge.pname || '';
    document.getElementById('propEdgeTransformer').value = edge.data_transformer || '';

    // Populate transformer datalist
    const datalist = document.getElementById('edgeTransformerList');
    datalist.innerHTML = '';
    dagState.transformers.forEach(t => {
        const option = document.createElement('option');
        option.value = t.name;
        datalist.appendChild(option);
    });
}

function updateSelectedEdgeProperty(prop, value) {
    if (canvasState.selectedEdge === null) return;

    const edge = dagState.edges[canvasState.selectedEdge];
    if (!edge) return;

    edge[prop] = value || null;
    renderEdges();
}

function deleteSelectedEdge() {
    if (canvasState.selectedEdge === null) return;

    dagState.edges.splice(canvasState.selectedEdge, 1);
    deselectAll();
    renderEdges();
    updateStatusBar();
}

// ==========================================
// Selection Management
// ==========================================
function selectNode(nodeId) {
    deselectAll();

    canvasState.selectedNode = nodeId;
    document.getElementById(nodeId).classList.add('selected');

    showNodeProperties(nodeId);
}

function deselectAll() {
    canvasState.selectedNode = null;
    canvasState.selectedEdge = null;
    canvasState.selectedComponent = null;
    canvasState.selectedComponentType = null;

    document.querySelectorAll('.canvas-node.selected').forEach(n => n.classList.remove('selected'));
    document.querySelectorAll('.component-list-item.selected').forEach(n => n.classList.remove('selected'));

    document.getElementById('emptyState').style.display = 'flex';
    document.getElementById('nodeProperties').style.display = 'none';
    document.getElementById('edgeProperties').style.display = 'none';
    document.getElementById('componentProperties').style.display = 'none';

    renderEdges();
    hideContextMenu();
}

// ==========================================
// Node Properties Panel
// ==========================================
function showNodeProperties(nodeId) {
    const node = dagState.nodes.find(n => n.id === nodeId);
    if (!node) return;

    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('nodeProperties').style.display = 'block';
    document.getElementById('edgeProperties').style.display = 'none';
    document.getElementById('componentProperties').style.display = 'none';

    document.getElementById('propNodeName').value = node.name;
    document.getElementById('propNodeType').value = node.type;

    const isSubscription = node.type === 'SubscriptionNode' || node.type === 'MetronomeNode';
    const isPublication = node.type === 'PublicationNode' || node.type === 'MetronomeNode' || node.type === 'PublisherSinkNode';
    const isMetronome = node.type === 'MetronomeNode';

    document.getElementById('subscriberSection').style.display = isSubscription ? 'block' : 'none';
    document.getElementById('publishersSection').style.display = isPublication ? 'block' : 'none';
    document.getElementById('metronomeSection').style.display = isMetronome ? 'block' : 'none';

    populateSubscriberDropdown(node.subscriber);
    populatePublisherCheckboxes(node.publishers || []);
    populateCalculatorDatalist(node.calculator);
    populateTransformerCheckboxes('input', node.input_transformers || []);
    populateTransformerCheckboxes('output', node.output_transformers || []);

    if (isMetronome) {
        document.getElementById('propInterval').value = node.config.interval || 60;
    }

    document.getElementById('propConfig').value = JSON.stringify(node.config || {}, null, 2);
}

function populateSubscriberDropdown(selected) {
    const select = document.getElementById('propSubscriber');
    select.innerHTML = '<option value="">-- Select Subscriber --</option>';

    dagState.subscribers.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.name;
        option.textContent = sub.name;
        if (sub.name === selected) option.selected = true;
        select.appendChild(option);
    });
}

function populatePublisherCheckboxes(selected) {
    const container = document.getElementById('publisherCheckboxes');
    container.innerHTML = '';

    if (dagState.publishers.length === 0) {
        container.innerHTML = '<small style="color: var(--text-muted);">No publishers defined</small>';
        return;
    }

    dagState.publishers.forEach(pub => {
        const div = document.createElement('div');
        div.className = 'property-checkbox';
        div.innerHTML = `
            <input type="checkbox" id="pub_${pub.name}" value="${pub.name}"
                ${selected.includes(pub.name) ? 'checked' : ''}
                onchange="updateSelectedNodePublishers()">
            <label for="pub_${pub.name}">${pub.name}</label>
        `;
        container.appendChild(div);
    });
}

function populateCalculatorDatalist(selected) {
    const input = document.getElementById('propCalculator');
    const datalist = document.getElementById('calculatorList');

    input.value = selected || '';
    datalist.innerHTML = '';

    dagState.calculators.forEach(calc => {
        const option = document.createElement('option');
        option.value = calc.name;
        datalist.appendChild(option);
    });
}

function populateTransformerCheckboxes(type, selected) {
    const containerId = type === 'input' ? 'inputTransformerCheckboxes' : 'outputTransformerCheckboxes';
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    if (dagState.transformers.length === 0) {
        container.innerHTML = '<small style="color: var(--text-muted);">No transformers defined</small>';
        return;
    }

    dagState.transformers.forEach(trans => {
        const div = document.createElement('div');
        div.className = 'property-checkbox';
        div.innerHTML = `
            <input type="checkbox" id="${type}_trans_${trans.name}" value="${trans.name}"
                ${selected.includes(trans.name) ? 'checked' : ''}
                onchange="updateSelectedNodeTransformers('${type}')">
            <label for="${type}_trans_${trans.name}">${trans.name}</label>
        `;
        container.appendChild(div);
    });
}

function updateSelectedNodeProperty(prop, value) {
    if (!canvasState.selectedNode) return;

    const node = dagState.nodes.find(n => n.id === canvasState.selectedNode);
    if (!node) return;

    if (prop === 'name') {
        const oldName = node.name;
        dagState.edges.forEach(edge => {
            if (edge.from_node === oldName) edge.from_node = value;
            if (edge.to_node === oldName) edge.to_node = value;
        });
    }

    if (value === null || value === '') {
        delete node[prop];
    } else {
        node[prop] = value;
    }

    updateNodeDisplay(canvasState.selectedNode);

    if (prop === 'type') {
        showNodeProperties(canvasState.selectedNode);
    }
}

function updateSelectedNodeConfig(key, value) {
    if (!canvasState.selectedNode) return;

    const node = dagState.nodes.find(n => n.id === canvasState.selectedNode);
    if (!node) return;

    if (key === null) {
        try {
            node.config = JSON.parse(value);
        } catch (e) {
            setStatus('Invalid JSON in config', 'error');
        }
    } else {
        node.config[key] = value;
    }
}

function updateSelectedNodePublishers() {
    if (!canvasState.selectedNode) return;

    const node = dagState.nodes.find(n => n.id === canvasState.selectedNode);
    if (!node) return;

    const checkboxes = document.querySelectorAll('#publisherCheckboxes input:checked');
    node.publishers = Array.from(checkboxes).map(cb => cb.value);

    updateNodeDisplay(canvasState.selectedNode);
}

function updateSelectedNodeTransformers(type) {
    if (!canvasState.selectedNode) return;

    const node = dagState.nodes.find(n => n.id === canvasState.selectedNode);
    if (!node) return;

    const containerId = type === 'input' ? 'inputTransformerCheckboxes' : 'outputTransformerCheckboxes';
    const checkboxes = document.querySelectorAll(`#${containerId} input:checked`);
    const key = type === 'input' ? 'input_transformers' : 'output_transformers';

    node[key] = Array.from(checkboxes).map(cb => cb.value);
}

function deleteSelectedNode() {
    if (!canvasState.selectedNode) return;

    const node = dagState.nodes.find(n => n.id === canvasState.selectedNode);
    if (!node) return;

    document.getElementById(canvasState.selectedNode).remove();

    const index = dagState.nodes.findIndex(n => n.id === canvasState.selectedNode);
    dagState.nodes.splice(index, 1);

    dagState.edges = dagState.edges.filter(e =>
        e.from_node !== node.name && e.to_node !== node.name
    );

    renderEdges();
    deselectAll();
    updateStatusBar();
    updateMinimap();
    hideContextMenu();
}

// ==========================================
// Component Management
// ==========================================
function createComponent(type, category) {
    const counter = dagState[category + 's'].length + 1;
    let component = {
        name: `${type.toLowerCase().replace('data', '').replace('subscriber', 'sub').replace('publisher', 'pub').replace('calculator', 'calc').replace('transformer', 'trans')}_${counter}`,
        config: {}
    };

    if (category === 'calculator' || category === 'transformer') {
        component.type = type;
    }

    // Default configs for Subscribers
    if (type === 'KafkaDataSubscriber') {
        component.config = {
            source: 'kafka://topic/input_topic',
            bootstrap_servers: ['localhost:9092'],
            group_id: 'dag_consumer_group',
            max_depth: 5000
        };
    } else if (type === 'RedisChannelDataSubscriber') {
        component.config = {
            source: 'redischannel://my_channel',
            host: 'localhost',
            port: 6379,
            db: 0
        };
    } else if (type === 'RabbitMQDataSubscriber') {
        component.config = {
            source: 'rabbitmq://queue/my_queue',
            host: 'localhost',
            port: 5672,
            username: 'guest',
            password: 'guest'
        };
    } else if (type === 'ActiveMQDataSubscriber') {
        component.config = {
            source: 'activemq://queue/my_queue',
            host: 'localhost',
            port: 61613,
            username: 'admin',
            password: 'admin'
        };
    } else if (type === 'GRPCDataSubscriber') {
        component.config = {
            source: 'grpc://localhost:50051/my_topic',
            use_ssl: false,
            subscriber_id: 'dag_subscriber'
        };
    } else if (type === 'FileDataSubscriber') {
        component.config = {
            source: 'file:///tmp/input.jsonl',
            read_interval: 1
        };
    } else if (type === 'InMemoryDataSubscriber') {
        component.config = {
            source: 'inmemory://queue/input_queue',
            max_size: 100000
        };
    } else if (type === 'InMemoryRedisDataSubscriber') {
        component.config = {
            source: 'inmemoryredis://',
            key_pattern: '*',
            poll_interval: 0.1,
            delete_on_read: false
        };
    } else if (type === 'InMemoryRedisChannelDataSubscriber') {
        component.config = {
            source: 'inmemoryredischannel://my_channel'
        };
    } else if (type === 'AshRedisChannelDataSubscriber') {
        component.config = {
            source: 'ashredischannel://my_channel',
            host: 'localhost',
            port: 6379
        };
    } else if (type === 'MetronomeDataSubscriber') {
        component.config = {
            source: 'metronome://tick',
            interval: 60,
            message: 'tick'
        };
    } else if (type === 'FaninDataSubscriber') {
        component.config = {
            source: 'fanin://',
            max_depth: 100000
        };
    } else if (type === 'FanoutDataSubscriber') {
        component.config = {
            source_subscriber: '',
            resolver_class: 'my.module.MyResolver',
            child_subscribers: {},
            unrouted_file: 'unrouted_messages.jsonl'
        };
    } else if (type === 'CustomDataSubscriber') {
        component.config = {
            source: 'custom://my_subscriber',
            delegate_module: 'my.module',
            delegate_class: 'MySubscriber',
            delegate_config: {},
            poll_interval: 1
        };
    }
    // Default configs for Publishers
    else if (type === 'KafkaDataPublisher') {
        component.config = {
            destination: 'kafka://topic/output_topic',
            bootstrap_servers: ['localhost:9092']
        };
    } else if (type === 'RedisDataPublisher') {
        component.config = {
            destination: 'redis://',
            host: 'localhost',
            port: 6379,
            db: 0
        };
    } else if (type === 'RedisChannelDataPublisher') {
        component.config = {
            destination: 'redischannel://my_channel',
            host: 'localhost',
            port: 6379,
            db: 0
        };
    } else if (type === 'RabbitMQDataPublisher') {
        component.config = {
            destination: 'rabbitmq://queue/my_queue',
            host: 'localhost',
            port: 5672,
            username: 'guest',
            password: 'guest'
        };
    } else if (type === 'ActiveMQDataPublisher') {
        component.config = {
            destination: 'activemq://queue/my_queue',
            host: 'localhost',
            port: 61613,
            username: 'admin',
            password: 'admin'
        };
    } else if (type === 'GRPCDataPublisher') {
        component.config = {
            destination: 'grpc://localhost:50051/my_topic',
            use_ssl: false,
            max_retries: 3,
            timeout: 30
        };
    } else if (type === 'FileDataPublisher') {
        component.config = {
            destination: 'file:///tmp/output.jsonl',
            publish_interval: 10,
            batch_size: 100
        };
    } else if (type === 'InMemoryDataPublisher') {
        component.config = {
            destination: 'inmemory://queue/output_queue',
            max_size: 100000
        };
    } else if (type === 'InMemoryRedisDataPublisher') {
        component.config = {
            destination: 'inmemoryredis://',
            key_prefix: '',
            ttl_seconds: null
        };
    } else if (type === 'InMemoryRedisChannelDataPublisher') {
        component.config = {
            destination: 'inmemoryredischannel://my_channel'
        };
    } else if (type === 'AshRedisDataPublisher') {
        component.config = {
            destination: 'ashredis://',
            host: 'localhost',
            port: 6379,
            ttl_seconds: null
        };
    } else if (type === 'AshRedisChannelDataPublisher') {
        component.config = {
            destination: 'ashredischannel://my_channel',
            host: 'localhost',
            port: 6379
        };
    } else if (type === 'AerospikeDataPublisher') {
        component.config = {
            destination: 'aerospike://namespace/set_name',
            hosts: [['localhost', 3000]]
        };
    } else if (type === 'MetronomeDataPublisher') {
        component.config = {
            destination: 'metronome://tick',
            interval: 60,
            message: 'tick'
        };
    } else if (type === 'FaninDataPublisher') {
        component.config = {
            destination: 'fanin://',
            publish_interval: 0
        };
    } else if (type === 'FanoutDataPublisher') {
        component.config = {
            destination: 'router://',
            resolver_class: 'my.module.MyResolver',
            child_publishers: {},
            unrouted_file: 'unrouted_messages.jsonl'
        };
    } else if (type === 'CustomDataPublisher') {
        component.config = {
            destination: 'custom://my_publisher',
            delegate_module: 'my.module',
            delegate_class: 'MyPublisher',
            delegate_config: {}
        };
    }
    // Default configs for Calculators and Transformers
    else if (type.includes('ApplyDefaults')) {
        component.config = { defaults: {} };
    } else if (type === 'AdditionCalculator' || type === 'MultiplicationCalculator') {
        component.config = { arguments: [], output_attribute: 'result' };
    } else if (type.includes('AttributeFilter') && !type.includes('Away')) {
        component.config = { keep_attributes: [] };
    }

    dagState[category + 's'].push(component);

    canvasState.selectedComponent = component.name;
    canvasState.selectedComponentType = category;
    showComponentProperties(component.name, category);
    updateComponentsLists();

    setStatus(`Created ${category}: ${component.name}`);
}

function selectComponent(name, category) {
    deselectAll();
    canvasState.selectedComponent = name;
    canvasState.selectedComponentType = category;

    document.querySelectorAll('.component-list-item').forEach(el => {
        if (el.dataset.name === name && el.dataset.category === category) {
            el.classList.add('selected');
        }
    });

    showComponentProperties(name, category);
}

function showComponentProperties(name, category) {
    const component = dagState[category + 's'].find(c => c.name === name);
    if (!component) return;

    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('nodeProperties').style.display = 'none';
    document.getElementById('edgeProperties').style.display = 'none';
    document.getElementById('componentProperties').style.display = 'block';

    document.getElementById('componentTypeTitle').textContent = category.charAt(0).toUpperCase() + category.slice(1) + ' Configuration';
    document.getElementById('propComponentName').value = component.name;

    const typeInput = document.getElementById('propComponentType');
    const datalist = document.getElementById('componentTypeList');

    typeInput.value = component.type || '';
    datalist.innerHTML = '';

    const types = getComponentTypes(category);
    types.forEach(t => {
        const option = document.createElement('option');
        option.value = t;
        datalist.appendChild(option);
    });

    document.getElementById('componentTypeGroup').style.display =
        (category === 'calculator' || category === 'transformer') ? 'block' : 'none';

    document.getElementById('propComponentConfig').value = JSON.stringify(component.config || {}, null, 2);
}

function getComponentTypes(category) {
    if (category === 'calculator') {
        return ['NullCalculator', 'PassthruCalculator', 'ApplyDefaultsCalculator',
                'AdditionCalculator', 'MultiplicationCalculator', 'AttributeFilterCalculator',
                'AttributeFilterAwayCalculator', 'AttributeNameChangeCalculator', 'RandomCalculator'];
    } else if (category === 'transformer') {
        return ['NullDataTransformer', 'PassthruDataTransformer', 'ApplyDefaultsDataTransformer',
                'AttributeFilterDataTransformer', 'AttributeFilterAwayDataTransformer'];
    }
    return [];
}

function updateSelectedComponent(prop, value) {
    if (!canvasState.selectedComponent || !canvasState.selectedComponentType) return;

    const component = dagState[canvasState.selectedComponentType + 's'].find(
        c => c.name === canvasState.selectedComponent
    );
    if (!component) return;

    if (prop === 'name') {
        const oldName = component.name;
        dagState.nodes.forEach(node => {
            if (node.subscriber === oldName) node.subscriber = value;
            if (node.calculator === oldName) node.calculator = value;
            if (node.publishers) node.publishers = node.publishers.map(p => p === oldName ? value : p);
            if (node.input_transformers) node.input_transformers = node.input_transformers.map(t => t === oldName ? value : t);
            if (node.output_transformers) node.output_transformers = node.output_transformers.map(t => t === oldName ? value : t);
        });
        dagState.edges.forEach(edge => {
            if (edge.data_transformer === oldName) edge.data_transformer = value;
        });
        canvasState.selectedComponent = value;
    }

    component[prop] = value;
    updateComponentsLists();
}

function updateSelectedComponentConfig(value) {
    if (!canvasState.selectedComponent || !canvasState.selectedComponentType) return;

    const component = dagState[canvasState.selectedComponentType + 's'].find(
        c => c.name === canvasState.selectedComponent
    );
    if (!component) return;

    try {
        component.config = JSON.parse(value);
    } catch (e) {
        setStatus('Invalid JSON', 'error');
    }
}

function deleteSelectedComponent() {
    if (!canvasState.selectedComponent || !canvasState.selectedComponentType) return;

    const category = canvasState.selectedComponentType;
    const name = canvasState.selectedComponent;

    const index = dagState[category + 's'].findIndex(c => c.name === name);
    if (index >= 0) {
        dagState[category + 's'].splice(index, 1);
    }

    dagState.nodes.forEach(node => {
        if (node.subscriber === name) delete node.subscriber;
        if (node.calculator === name) delete node.calculator;
        if (node.publishers) node.publishers = node.publishers.filter(p => p !== name);
        if (node.input_transformers) node.input_transformers = node.input_transformers.filter(t => t !== name);
        if (node.output_transformers) node.output_transformers = node.output_transformers.filter(t => t !== name);
    });

    dagState.edges.forEach(edge => {
        if (edge.data_transformer === name) edge.data_transformer = null;
    });

    deselectAll();
    updateComponentsLists();
    setStatus(`Deleted ${category}: ${name}`);
}

function updateComponentsLists() {
    updateComponentList('subscriber', 'subscribersList', 'subscriberCount');
    updateComponentList('publisher', 'publishersList', 'publisherCount');
    updateComponentList('calculator', 'calculatorsList', 'calculatorCount');
    updateComponentList('transformer', 'transformersList', 'transformerCount');
}

function updateComponentList(category, listId, countId) {
    const list = document.getElementById(listId);
    const count = document.getElementById(countId);
    const items = dagState[category + 's'];

    count.textContent = items.length;

    if (items.length === 0) {
        list.innerHTML = '<div class="empty-component-list">None defined</div>';
        return;
    }

    list.innerHTML = items.map(item => `
        <div class="component-list-item ${canvasState.selectedComponent === item.name && canvasState.selectedComponentType === category ? 'selected' : ''}"
             data-name="${item.name}" data-category="${category}"
             onclick="selectComponent('${item.name}', '${category}')">
            <div>
                <div class="item-name">${item.name}</div>
                ${item.type ? `<div class="item-type">${item.type}</div>` : ''}
            </div>
            <div class="item-actions">
                <button class="item-btn delete" onclick="event.stopPropagation(); deleteComponentByName('${item.name}', '${category}')" title="Delete">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function deleteComponentByName(name, category) {
    canvasState.selectedComponent = name;
    canvasState.selectedComponentType = category;
    deleteSelectedComponent();
}

// ==========================================
// Context Menu
// ==========================================
function showContextMenu(x, y) {
    const menu = document.getElementById('contextMenu');
    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;
    menu.classList.add('show');
}

function hideContextMenu() {
    document.getElementById('contextMenu').classList.remove('show');
}

function duplicateNode() {
    if (!canvasState.selectedNode) return;

    const node = dagState.nodes.find(n => n.id === canvasState.selectedNode);
    if (!node) return;

    createNode(node.type, node.x + 40, node.y + 40);

    const newNode = dagState.nodes[dagState.nodes.length - 1];
    if (node.subscriber) newNode.subscriber = node.subscriber;
    if (node.calculator) newNode.calculator = node.calculator;
    if (node.publishers) newNode.publishers = [...node.publishers];
    if (node.input_transformers) newNode.input_transformers = [...node.input_transformers];
    if (node.output_transformers) newNode.output_transformers = [...node.output_transformers];
    newNode.config = JSON.parse(JSON.stringify(node.config));

    updateNodeDisplay(newNode.id);
    hideContextMenu();
}

function connectFromNode() {
    if (!canvasState.selectedNode) return;
    startConnection(canvasState.selectedNode);
    hideContextMenu();
}

// ==========================================
// DAG Settings
// ==========================================
function showDagSettings() {
    document.getElementById('settingsStartTime').value = dagState.start_time || '';
    document.getElementById('settingsDuration').value = dagState.duration || '';

    const hasAutoclone = dagState.autoclone !== null;
    document.getElementById('settingsAutocloneEnabled').checked = hasAutoclone;
    document.getElementById('autocloneSettings').style.display = hasAutoclone ? 'block' : 'none';

    if (hasAutoclone && dagState.autoclone) {
        document.getElementById('settingsRampUpTime').value = dagState.autoclone.ramp_up_time || '';
        document.getElementById('settingsCloneDuration').value = dagState.autoclone.duration || '';
        document.getElementById('settingsRampCount').value = dagState.autoclone.ramp_count || 5;
    }

    new bootstrap.Modal(document.getElementById('dagSettingsModal')).show();
}

function toggleAutocloneSettings() {
    const enabled = document.getElementById('settingsAutocloneEnabled').checked;
    document.getElementById('autocloneSettings').style.display = enabled ? 'block' : 'none';
}

function saveDagSettings() {
    dagState.start_time = document.getElementById('settingsStartTime').value || null;
    dagState.duration = document.getElementById('settingsDuration').value || null;

    if (document.getElementById('settingsAutocloneEnabled').checked) {
        dagState.autoclone = {
            ramp_up_time: document.getElementById('settingsRampUpTime').value,
            duration: document.getElementById('settingsCloneDuration').value || undefined,
            ramp_count: parseInt(document.getElementById('settingsRampCount').value) || 5
        };
    } else {
        dagState.autoclone = null;
    }

    bootstrap.Modal.getInstance(document.getElementById('dagSettingsModal')).hide();
    setStatus('DAG settings saved');
}

// ==========================================
// Import/Export
// ==========================================
function generateDagJson() {
    const dagName = document.getElementById('dagName').value.trim();

    const output = { name: dagName || 'untitled_dag' };

    if (dagState.start_time) output.start_time = dagState.start_time;
    if (dagState.duration) output.duration = dagState.duration;
    if (dagState.autoclone) output.autoclone = dagState.autoclone;

    output.subscribers = dagState.subscribers.map(s => ({ name: s.name, config: s.config }));
    output.publishers = dagState.publishers.map(p => ({ name: p.name, config: p.config }));
    output.calculators = dagState.calculators.map(c => ({ name: c.name, type: c.type, config: c.config }));
    output.transformers = dagState.transformers.map(t => ({ name: t.name, type: t.type, config: t.config }));

    output.nodes = dagState.nodes.map(n => {
        const node = { name: n.name, type: n.type, config: n.config || {} };
        if (n.subscriber) node.subscriber = n.subscriber;
        if (n.publishers && n.publishers.length > 0) node.publishers = n.publishers;
        if (n.calculator) node.calculator = n.calculator;
        if (n.input_transformers && n.input_transformers.length > 0) node.input_transformers = n.input_transformers;
        if (n.output_transformers && n.output_transformers.length > 0) node.output_transformers = n.output_transformers;
        return node;
    });

    output.edges = dagState.edges.map(e => {
        const edge = { from_node: e.from_node, to_node: e.to_node };
        if (e.pname) edge.pname = e.pname;
        if (e.data_transformer) edge.data_transformer = e.data_transformer;
        return edge;
    });

    return output;
}

function previewJson() {
    const json = generateDagJson();
    document.getElementById('jsonPreviewContent').textContent = JSON.stringify(json, null, 2);
    new bootstrap.Modal(document.getElementById('jsonPreviewModal')).show();
}

function copyJsonToClipboard() {
    const json = generateDagJson();
    navigator.clipboard.writeText(JSON.stringify(json, null, 2)).then(() => {
        setStatus('Copied to clipboard');
    });
}

function exportToFile() {
    const json = generateDagJson();
    const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `${json.name}.json`;
    a.click();

    URL.revokeObjectURL(url);
    setStatus('DAG exported');
}

function loadFromFile() {
    document.getElementById('fileInput').click();
}

function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const json = JSON.parse(e.target.result);
            importDagJson(json);
            document.getElementById('dagName').value = json.name || '';
            setStatus('DAG imported');
        } catch (err) {
            setStatus('Error parsing JSON', 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function loadExistingDag(dagName) {
    if (!dagName) return;
    window.location.href = `{{ url_for('dag_designer') }}/load/${dagName}`;
}

function importDagJson(json) {
    clearCanvas(false);

    dagState.name = json.name || '';
    dagState.start_time = json.start_time || null;
    dagState.duration = json.duration || null;
    dagState.autoclone = json.autoclone || null;

    dagState.subscribers = (json.subscribers || []).map(s => ({ name: s.name, config: s.config || {} }));
    dagState.publishers = (json.publishers || []).map(p => ({ name: p.name, config: p.config || {} }));
    dagState.calculators = (json.calculators || []).map(c => ({ name: c.name, type: c.type || 'NullCalculator', config: c.config || {} }));
    dagState.transformers = (json.transformers || []).map(t => ({ name: t.name, type: t.type || 'NullDataTransformer', config: t.config || {} }));

    const nodeCount = json.nodes ? json.nodes.length : 0;
    const cols = Math.ceil(Math.sqrt(nodeCount));

    (json.nodes || []).forEach((n, i) => {
        canvasState.nodeCounter++;
        const nodeId = `node_${canvasState.nodeCounter}`;

        const col = i % cols;
        const row = Math.floor(i / cols);
        const x = 80 + col * 220;
        const y = 80 + row * 130;

        const node = {
            id: nodeId,
            name: n.name,
            type: n.type || 'CalculationNode',
            config: n.config || {},
            x: x,
            y: y
        };

        if (n.subscriber) node.subscriber = n.subscriber;
        if (n.publishers) node.publishers = n.publishers;
        if (n.calculator) node.calculator = n.calculator;
        if (n.input_transformers) node.input_transformers = n.input_transformers;
        if (n.output_transformers) node.output_transformers = n.output_transformers;

        dagState.nodes.push(node);
        renderNode(node);
    });

    dagState.edges = (json.edges || []).map(e => ({
        from_node: e.from_node,
        to_node: e.to_node,
        pname: e.pname || '',
        data_transformer: e.data_transformer || null
    }));

    renderEdges();
    updateStatusBar();
    updateMinimap();
    updateComponentsLists();
}

function clearCanvas(confirm = true) {
    if (confirm && dagState.nodes.length > 0) {
        if (!window.confirm('Clear all?')) return;
    }

    document.getElementById('dag-canvas').innerHTML = '';
    document.querySelectorAll('#edges-svg .edge-path').forEach(e => e.remove());
    document.querySelectorAll('#edges-svg .edge-label').forEach(e => e.remove());

    dagState.name = '';
    dagState.start_time = null;
    dagState.duration = null;
    dagState.autoclone = null;
    dagState.subscribers = [];
    dagState.publishers = [];
    dagState.calculators = [];
    dagState.transformers = [];
    dagState.nodes = [];
    dagState.edges = [];

    canvasState.nodeCounter = 0;
    canvasState.selectedNode = null;
    canvasState.selectedEdge = null;
    canvasState.selectedComponent = null;

    document.getElementById('dagName').value = '';

    deselectAll();
    updateStatusBar();
    updateMinimap();
    updateComponentsLists();
    setStatus('Canvas cleared');
}

// ==========================================
// Validation
// ==========================================
function validateDag() {
    const json = generateDagJson();

    fetch('{{ url_for("dag_designer_validate") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(result => showValidationResults(result))
    .catch(err => setStatus('Validation failed', 'error'));
}

function showValidationResults(result) {
    const title = document.getElementById('validationTitle');
    const content = document.getElementById('validationContent');

    if (result.valid) {
        title.innerHTML = '<i class="bi bi-check-circle text-success"></i> Valid';
        content.innerHTML = '<div class="alert alert-success mb-0">DAG configuration is valid!</div>';
    } else {
        title.innerHTML = '<i class="bi bi-exclamation-circle text-danger"></i> Invalid';
        let html = '';
        if (result.errors.length > 0) {
            html += '<div class="alert alert-danger"><strong>Errors:</strong><ul class="mb-0">';
            result.errors.forEach(e => html += `<li>${e}</li>`);
            html += '</ul></div>';
        }
        if (result.warnings.length > 0) {
            html += '<div class="alert alert-warning mb-0"><strong>Warnings:</strong><ul class="mb-0">';
            result.warnings.forEach(w => html += `<li>${w}</li>`);
            html += '</ul></div>';
        }
        content.innerHTML = html;
    }

    new bootstrap.Modal(document.getElementById('validationModal')).show();
}

// ==========================================
// Zoom
// ==========================================
function zoomIn() {
    canvasState.zoom = Math.min(canvasState.zoom * 1.2, 3);
    applyZoom();
}

function zoomOut() {
    canvasState.zoom = Math.max(canvasState.zoom / 1.2, 0.3);
    applyZoom();
}

function resetZoom() {
    canvasState.zoom = 1;
    applyZoom();
}

function fitToCanvas() {
    if (dagState.nodes.length === 0) return;

    const wrapper = document.getElementById('canvasWrapper');
    const wrapperRect = wrapper.getBoundingClientRect();

    let minX = Infinity, minY = Infinity, maxX = 0, maxY = 0;
    dagState.nodes.forEach(node => {
        minX = Math.min(minX, node.x);
        minY = Math.min(minY, node.y);
        maxX = Math.max(maxX, node.x + 180);
        maxY = Math.max(maxY, node.y + 80);
    });

    const contentWidth = maxX - minX + 100;
    const contentHeight = maxY - minY + 100;

    const scaleX = wrapperRect.width / contentWidth;
    const scaleY = wrapperRect.height / contentHeight;

    canvasState.zoom = Math.min(scaleX, scaleY, 1);
    applyZoom();
}

function applyZoom() {
    const canvas = document.getElementById('dag-canvas');
    const svg = document.getElementById('edges-svg');

    canvas.style.transform = `scale(${canvasState.zoom})`;
    canvas.style.transformOrigin = '0 0';
    svg.style.transform = `scale(${canvasState.zoom})`;
    svg.style.transformOrigin = '0 0';

    document.getElementById('zoomLevel').textContent = Math.round(canvasState.zoom * 100) + '%';
}

// ==========================================
// Minimap
// ==========================================
function updateMinimap() {
    const content = document.getElementById('minimapContent');
    content.innerHTML = '';

    if (dagState.nodes.length === 0) return;

    let minX = Infinity, minY = Infinity, maxX = 0, maxY = 0;
    dagState.nodes.forEach(node => {
        minX = Math.min(minX, node.x);
        minY = Math.min(minY, node.y);
        maxX = Math.max(maxX, node.x + 180);
        maxY = Math.max(maxY, node.y + 80);
    });

    const width = maxX - minX + 40;
    const height = maxY - minY + 40;
    const scale = Math.min(160 / width, 100 / height);

    dagState.nodes.forEach(node => {
        const dot = document.createElement('div');
        dot.className = 'minimap-node';
        dot.style.left = `${(node.x - minX + 20) * scale}px`;
        dot.style.top = `${(node.y - minY + 20) * scale}px`;
        dot.style.width = `${Math.max(4, 180 * scale * 0.25)}px`;
        dot.style.height = `${Math.max(3, 80 * scale * 0.25)}px`;
        content.appendChild(dot);
    });
}

// ==========================================
// Utility
// ==========================================
function togglePaletteSection(header) {
    header.classList.toggle('collapsed');
    const items = header.nextElementSibling;
    items.style.display = header.classList.contains('collapsed') ? 'none' : 'flex';
}

function setStatus(message, type = 'success') {
    document.getElementById('statusText').textContent = message;
    const dot = document.getElementById('statusDot');
    dot.className = 'status-dot';
    if (type === 'warning') dot.classList.add('warning');
    if (type === 'error') dot.classList.add('error');
}

function updateStatusBar() {
    document.getElementById('nodeCount').textContent = dagState.nodes.length;
    document.getElementById('edgeCount').textContent = dagState.edges.length;
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.context-menu')) {
        hideContextMenu();
    }
});
</script>
{% endblock %}