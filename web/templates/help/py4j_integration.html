{% extends "base.html" %}

{% block title %}Py4J Java Integration - {{ app_name }} Help{% endblock %}

{% block extra_css %}
<style>
    .help-nav {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    .code-block {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 0.85rem;
        overflow-x: auto;
        white-space: pre;
    }
    .code-block.java {
        border-left: 4px solid #f89820;
    }
    .code-block.python {
        border-left: 4px solid #3776ab;
    }
    .code-block.json {
        border-left: 4px solid #10b981;
    }
    .code-block.bash {
        border-left: 4px solid #64748b;
    }
    .tip-box {
        background: linear-gradient(135deg, #ecfdf5, #d1fae5);
        border-left: 4px solid #10b981;
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin: 1rem 0;
    }
    .warning-box {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin: 1rem 0;
    }
    .info-box {
        background: linear-gradient(135deg, #e0f2fe, #bae6fd);
        border-left: 4px solid #0ea5e9;
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin: 1rem 0;
    }
    .danger-box {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        border-left: 4px solid #ef4444;
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin: 1rem 0;
    }
    .performance-card {
        background: linear-gradient(135deg, #1e3a5f, #2d5a87);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    .performance-card h5 {
        color: #00d4aa;
        margin-bottom: 1rem;
    }
    .performance-metric {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .performance-metric:last-child {
        border-bottom: none;
    }
    .metric-label {
        color: rgba(255,255,255,0.8);
    }
    .metric-value {
        color: #00d4aa;
        font-weight: 600;
    }
    .arch-diagram {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
        text-align: center;
    }
    .arch-box {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        margin: 0.5rem;
        border-radius: 8px;
        font-weight: 500;
    }
    .arch-python {
        background: linear-gradient(135deg, #3776ab, #2d5a87);
        color: white;
    }
    .arch-java {
        background: linear-gradient(135deg, #f89820, #e07d10);
        color: white;
    }
    .arch-arrow {
        display: inline-block;
        font-size: 1.5rem;
        color: #64748b;
        margin: 0 1rem;
    }
    .vs-table {
        margin: 1rem 0;
    }
    .vs-table th {
        background: linear-gradient(135deg, #1e3a5f, #2d5a87);
        color: white;
    }
    .badge-java {
        background: linear-gradient(135deg, #f89820, #e07d10);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation -->
<div class="help-nav">
    <a href="{{ url_for('help') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back to Help
    </a>
</div>

<h2><i class="bi bi-cup-hot-fill" style="color: #f89820;"></i> Py4J Java Integration</h2>
<p class="lead">Leverage high-performance Java calculators for real-time data processing that beats Spark.</p>

<!-- Table of Contents -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list"></i> Contents</h5>
    </div>
    <div class="card-body">
        <ul class="mb-0">
            <li><a href="#overview">Overview & Architecture</a></li>
            <li><a href="#why-java">Why Java Calculators?</a></li>
            <li><a href="#setup">Setup Guide</a></li>
            <li><a href="#java-calculator">Writing Java Calculators</a></li>
            <li><a href="#configuration">DAG Configuration</a></li>
            <li><a href="#gateway-pooling">Gateway Pooling for High Performance</a></li>
            <li><a href="#examples">Complete Examples</a></li>
            <li><a href="#beating-spark">Beating Spark</a></li>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
        </ul>
    </div>
</div>

<!-- Overview -->
<div class="card mb-4" id="overview">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Overview & Architecture</h5>
    </div>
    <div class="card-body">
        <p>DishtaYantra integrates with Java via <strong>Py4J</strong>, allowing you to write calculators in Java while orchestrating them from Python. This gives you the best of both worlds:</p>
        
        <div class="arch-diagram">
            <h6 class="mb-3">Architecture</h6>
            <div>
                <span class="arch-box arch-python"><i class="bi bi-filetype-py"></i> DishtaYantra (Python)</span>
                <span class="arch-arrow">⟷</span>
                <span class="arch-box" style="background: #6b7280; color: white;"><i class="bi bi-arrow-left-right"></i> Py4J Bridge</span>
                <span class="arch-arrow">⟷</span>
                <span class="arch-box arch-java"><i class="bi bi-cup-hot-fill"></i> Java Gateway Server</span>
            </div>
            <div class="mt-3">
                <small class="text-muted">Python handles orchestration, routing, and I/O • Java handles computation</small>
            </div>
        </div>
        
        <h6 class="mt-4">Key Components</h6>
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Component</th>
                    <th>Language</th>
                    <th>Purpose</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>JavaCalculator</code></td>
                    <td>Python</td>
                    <td>Wrapper that calls Java via Py4J</td>
                </tr>
                <tr>
                    <td><code>JavaGatewayPool</code></td>
                    <td>Python</td>
                    <td>Connection pool for high concurrency</td>
                </tr>
                <tr>
                    <td><code>DishtaYantraGateway</code></td>
                    <td>Java</td>
                    <td>Gateway server that hosts Java calculators</td>
                </tr>
                <tr>
                    <td><code>AbstractCalculator</code></td>
                    <td>Java</td>
                    <td>Base class for Java calculators</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Why Java -->
<div class="card mb-4" id="why-java">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Why Java Calculators?</h5>
    </div>
    <div class="card-body">
        <p>Java provides significant advantages for computation-heavy workloads:</p>
        
        <table class="table table-bordered vs-table">
            <thead>
                <tr>
                    <th>Aspect</th>
                    <th>Python Calculator</th>
                    <th>Java Calculator</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Raw Computation Speed</strong></td>
                    <td>Baseline</td>
                    <td><span class="badge bg-success">10-100x faster</span></td>
                </tr>
                <tr>
                    <td><strong>Memory Efficiency</strong></td>
                    <td>Higher overhead</td>
                    <td><span class="badge bg-success">Lower overhead</span></td>
                </tr>
                <tr>
                    <td><strong>JIT Compilation</strong></td>
                    <td>Limited (PyPy only)</td>
                    <td><span class="badge bg-success">HotSpot JIT</span></td>
                </tr>
                <tr>
                    <td><strong>Parallel Execution</strong></td>
                    <td>GIL-limited (without free-threading)</td>
                    <td><span class="badge bg-success">True multi-threading</span></td>
                </tr>
                <tr>
                    <td><strong>Existing Libraries</strong></td>
                    <td>Python ecosystem</td>
                    <td><span class="badge bg-success">Java ecosystem</span></td>
                </tr>
                <tr>
                    <td><strong>Development Speed</strong></td>
                    <td><span class="badge bg-success">Faster</span></td>
                    <td>More verbose</td>
                </tr>
            </tbody>
        </table>
        
        <div class="performance-card">
            <h5><i class="bi bi-speedometer2"></i> Performance Comparison</h5>
            <div class="performance-metric">
                <span class="metric-label">Simple Math Operations</span>
                <span class="metric-value">Java 15-20x faster</span>
            </div>
            <div class="performance-metric">
                <span class="metric-label">Complex Financial Calculations</span>
                <span class="metric-value">Java 30-50x faster</span>
            </div>
            <div class="performance-metric">
                <span class="metric-label">String Processing</span>
                <span class="metric-value">Java 5-10x faster</span>
            </div>
            <div class="performance-metric">
                <span class="metric-label">Data Transformation (JSON)</span>
                <span class="metric-value">Java 10-20x faster</span>
            </div>
            <p class="mt-3 mb-0" style="font-size: 0.85rem; opacity: 0.8;">
                <i class="bi bi-info-circle"></i> Py4J adds ~0.1-0.5ms overhead per call. For calculations taking >1ms, this is negligible.
            </p>
        </div>
        
        <div class="tip-box">
            <strong><i class="bi bi-lightbulb"></i> When to Use Java Calculators:</strong>
            <ul class="mb-0 mt-2">
                <li>CPU-intensive calculations (risk analytics, pricing, statistics)</li>
                <li>High-throughput scenarios (>10,000 calculations/second)</li>
                <li>Leveraging existing Java libraries (QuantLib, Apache Commons Math)</li>
                <li>Regulatory requirements for audited Java code</li>
            </ul>
        </div>
    </div>
</div>

<!-- Setup Guide -->
<div class="card mb-4" id="setup">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-gear"></i> Setup Guide</h5>
    </div>
    <div class="card-body">
        <h6>Step 1: Install Py4J (Python Side)</h6>
        <div class="code-block bash">pip install py4j</div>
        
        <h6 class="mt-4">Step 2: Download Py4J JAR (Java Side)</h6>
        <div class="code-block bash"># Download Py4J JAR
wget https://repo1.maven.org/maven2/net/sf/py4j/py4j/0.10.9.7/py4j-0.10.9.7.jar

# Or via Maven (add to pom.xml)
&lt;dependency&gt;
    &lt;groupId&gt;net.sf.py4j&lt;/groupId&gt;
    &lt;artifactId&gt;py4j&lt;/artifactId&gt;
    &lt;version&gt;0.10.9.7&lt;/version&gt;
&lt;/dependency&gt;</div>
        
        <h6 class="mt-4">Step 3: Compile Java Calculators</h6>
        <div class="code-block bash"># Compile the DishtaYantra Java components
cd java/src
javac -cp ".:py4j-0.10.9.7.jar" \
    com/dishtayantra/calculators/*.java \
    com/dishtayantra/calculators/examples/*.java \
    com/dishtayantra/gateway/*.java

# Create JAR file
jar cvf dishtayantra-calculators.jar com/</div>
        
        <h6 class="mt-4">Step 4: Start Java Gateway Server</h6>
        <div class="code-block bash"># Start single gateway (default port 25333)
java -cp "dishtayantra-calculators.jar:py4j-0.10.9.7.jar" \
    com.dishtayantra.gateway.DishtaYantraGateway

# Start with multiple gateway instances for high performance
java -cp "dishtayantra-calculators.jar:py4j-0.10.9.7.jar" \
    com.dishtayantra.gateway.DishtaYantraGateway --pool-size 4

# Custom port
java -cp "dishtayantra-calculators.jar:py4j-0.10.9.7.jar" \
    com.dishtayantra.gateway.DishtaYantraGateway --port 25340 --pool-size 8</div>
        
        <h6 class="mt-4">Step 5: Verify Connection</h6>
        <div class="code-block python"># Test from Python
from py4j.java_gateway import JavaGateway

gateway = JavaGateway()  # Connects to localhost:25333
print(gateway.jvm.System.currentTimeMillis())  # Should print timestamp</div>
        
        <div class="info-box">
            <strong><i class="bi bi-info-circle"></i> Docker Deployment:</strong>
            Run the Java gateway in a separate container and configure DishtaYantra to connect via hostname.
        </div>
    </div>
</div>

<!-- Writing Java Calculators -->
<div class="card mb-4" id="java-calculator">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-code-slash"></i> Writing Java Calculators</h5>
    </div>
    <div class="card-body">
        <p>Java calculators must follow this interface:</p>
        
        <div class="code-block java">package com.yourcompany.calculators;

import java.util.Map;
import java.util.HashMap;

/**
 * Your custom calculator.
 * Must have:
 * - Constructor(String name, Map&lt;String, Object&gt; config)
 * - Map&lt;String, Object&gt; calculate(Map&lt;String, Object&gt; data)
 * - Map&lt;String, Object&gt; details()
 */
public class MyCalculator {
    
    private final String name;
    private final Map&lt;String, Object&gt; config;
    private long calculationCount = 0;
    
    // Constructor - same signature as Python DataCalculator
    public MyCalculator(String name, Map&lt;String, Object&gt; config) {
        this.name = name;
        this.config = config;
    }
    
    // Main calculation method
    public Map&lt;String, Object&gt; calculate(Map&lt;String, Object&gt; data) {
        calculationCount++;
        
        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;(data);
        
        // Your calculation logic here
        double value = ((Number) data.get("input")).doubleValue();
        result.put("output", value * 2);
        
        return result;
    }
    
    // Details method for monitoring
    public Map&lt;String, Object&gt; details() {
        Map&lt;String, Object&gt; details = new HashMap&lt;&gt;();
        details.put("name", name);
        details.put("type", "MyCalculator");
        details.put("calculation_count", calculationCount);
        return details;
    }
}</div>
        
        <h6 class="mt-4">Using AbstractCalculator Base Class</h6>
        <p>For easier development, extend <code>AbstractCalculator</code>:</p>
        
        <div class="code-block java">package com.yourcompany.calculators;

import com.dishtayantra.calculators.AbstractCalculator;
import java.util.Map;
import java.util.HashMap;

public class PricingCalculator extends AbstractCalculator {
    
    private final double marginRate;
    
    public PricingCalculator(String name, Map&lt;String, Object&gt; config) {
        super(name, config);
        // Get config with default value
        this.marginRate = getConfig("margin_rate", 0.05);
    }
    
    @Override
    protected Map&lt;String, Object&gt; doCalculate(Map&lt;String, Object&gt; data) {
        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;(data);
        
        double price = ((Number) data.get("price")).doubleValue();
        double quantity = ((Number) data.get("quantity")).doubleValue();
        
        double grossValue = price * quantity;
        double margin = grossValue * marginRate;
        double netValue = grossValue + margin;
        
        result.put("gross_value", grossValue);
        result.put("margin", margin);
        result.put("net_value", netValue);
        
        return result;
    }
    
    @Override
    protected Map&lt;String, Object&gt; getCustomDetails() {
        Map&lt;String, Object&gt; custom = new HashMap&lt;&gt;();
        custom.put("margin_rate", marginRate);
        return custom;
    }
}</div>
    </div>
</div>

<!-- DAG Configuration -->
<div class="card mb-4" id="configuration">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-filetype-json"></i> DAG Configuration</h5>
    </div>
    <div class="card-body">
        <p>Configure a Java calculator in your DAG JSON:</p>
        
        <div class="code-block json">{
  "name": "trade_pricing_dag",
  "start_time": "0900",
  "duration": "8h",
  "nodes": [
    {
      "id": "subscriber",
      "type": "SubscriptionNode",
      "subscribers": [
        {"uri": "kafka://trades:trade_input", "group_id": "pricing"}
      ]
    },
    {
      "id": "java_pricing",
      "type": "CalculationNode",
      "calculator": "java",
      "java_class": "com.yourcompany.calculators.PricingCalculator",
      "margin_rate": 0.03,
      "gateway_config": {
        "pool_size": 4,
        "gateway_addresses": [
          {"host": "localhost", "port": 25333},
          {"host": "localhost", "port": 25334},
          {"host": "localhost", "port": 25335},
          {"host": "localhost", "port": 25336}
        ]
      }
    },
    {
      "id": "publisher",
      "type": "PublicationNode",
      "publishers": [
        {"uri": "kafka://trades:priced_trades"}
      ]
    }
  ],
  "edges": [
    {"from": "subscriber", "to": "java_pricing"},
    {"from": "java_pricing", "to": "publisher"}
  ]
}</div>
        
        <h6 class="mt-4">Configuration Options</h6>
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Property</th>
                    <th>Required</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>calculator</code></td>
                    <td>Yes</td>
                    <td>Set to <code>"java"</code> for Java calculators</td>
                </tr>
                <tr>
                    <td><code>java_class</code></td>
                    <td>Yes</td>
                    <td>Fully qualified Java class name</td>
                </tr>
                <tr>
                    <td><code>gateway_config</code></td>
                    <td>No</td>
                    <td>Gateway pool configuration (see below)</td>
                </tr>
                <tr>
                    <td><em>any other</em></td>
                    <td>No</td>
                    <td>Passed to Java calculator's config map</td>
                </tr>
            </tbody>
        </table>
        
        <h6 class="mt-4">Gateway Config Options</h6>
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Property</th>
                    <th>Default</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>pool_size</code></td>
                    <td>4</td>
                    <td>Number of gateway connections</td>
                </tr>
                <tr>
                    <td><code>gateway_addresses</code></td>
                    <td>localhost:25333-25336</td>
                    <td>List of gateway host:port pairs</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Gateway Pooling -->
<div class="card mb-4" id="gateway-pooling">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-collection"></i> Gateway Pooling for High Performance</h5>
    </div>
    <div class="card-body">
        <p>For maximum throughput, use multiple gateway connections:</p>
        
        <div class="arch-diagram">
            <h6 class="mb-3">Gateway Pool Architecture</h6>
            <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap;">
                <div style="text-align: center; margin: 1rem;">
                    <span class="arch-box arch-python">Python Thread 1</span><br>
                    <span class="arch-box arch-python">Python Thread 2</span><br>
                    <span class="arch-box arch-python">Python Thread 3</span><br>
                    <span class="arch-box arch-python">Python Thread 4</span>
                </div>
                <div style="text-align: center; margin: 1rem;">
                    <span class="arch-arrow">⟷</span>
                </div>
                <div style="text-align: center; margin: 1rem;">
                    <div style="background: #f0f0f0; padding: 1rem; border-radius: 8px;">
                        <strong>Gateway Pool</strong><br>
                        <small>Thread-local assignment</small>
                    </div>
                </div>
                <div style="text-align: center; margin: 1rem;">
                    <span class="arch-arrow">⟷</span>
                </div>
                <div style="text-align: center; margin: 1rem;">
                    <span class="arch-box arch-java">JVM :25333</span><br>
                    <span class="arch-box arch-java">JVM :25334</span><br>
                    <span class="arch-box arch-java">JVM :25335</span><br>
                    <span class="arch-box arch-java">JVM :25336</span>
                </div>
            </div>
        </div>
        
        <h6 class="mt-4">How It Works</h6>
        <ol>
            <li><strong>Thread-Local Assignment:</strong> Each Python thread is assigned to a specific gateway connection</li>
            <li><strong>No Lock Contention:</strong> Different threads use different connections in parallel</li>
            <li><strong>Automatic Reconnection:</strong> Failed connections are automatically restored</li>
            <li><strong>Statistics Tracking:</strong> Monitor pool performance via <code>details()</code></li>
        </ol>
        
        <div class="code-block python"># Python: Gateway pool is created automatically
# Each DAG subscriber thread gets its own gateway connection

# Check pool stats
from core.calculator.java_calculator import get_gateway_pool

pool = get_gateway_pool()
stats = pool.get_stats()
print(f"Active connections: {stats['active_connections']}")
print(f"Total requests: {stats['total_requests']}")
print(f"Success rate: {stats['successful_requests'] / stats['total_requests'] * 100:.1f}%")</div>
        
        <div class="tip-box">
            <strong><i class="bi bi-lightbulb"></i> Sizing the Pool:</strong>
            <ul class="mb-0 mt-2">
                <li>Set pool_size = number of concurrent DAG threads that will use Java calculators</li>
                <li>For 10 DAGs with 1 Java calculator each: pool_size = 10</li>
                <li>More connections = more parallelism but more memory</li>
            </ul>
        </div>
    </div>
</div>

<!-- Examples -->
<div class="card mb-4" id="examples">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-code-square"></i> Complete Examples</h5>
    </div>
    <div class="card-body">
        <h6>Example 1: Trade Risk Calculator</h6>
        
        <p><strong>Java Code:</strong></p>
        <div class="code-block java">package com.trading.risk;

import com.dishtayantra.calculators.AbstractCalculator;
import java.util.Map;
import java.util.HashMap;

public class VaRCalculator extends AbstractCalculator {
    
    private final double confidenceLevel;
    private final int lookbackDays;
    
    public VaRCalculator(String name, Map&lt;String, Object&gt; config) {
        super(name, config);
        this.confidenceLevel = getConfig("confidence_level", 0.95);
        this.lookbackDays = getConfig("lookback_days", 252);
    }
    
    @Override
    protected Map&lt;String, Object&gt; doCalculate(Map&lt;String, Object&gt; data) {
        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;(data);
        
        double positionValue = toDouble(data.get("position_value"));
        double volatility = toDouble(data.get("volatility"));
        
        // Z-score for confidence level
        double zScore = getZScore(confidenceLevel);
        
        // Daily VaR
        double dailyVaR = positionValue * volatility * zScore / Math.sqrt(lookbackDays);
        result.put("daily_var", dailyVaR);
        
        // 10-day VaR
        result.put("var_10d", dailyVaR * Math.sqrt(10));
        
        // Annual VaR
        result.put("annual_var", dailyVaR * Math.sqrt(252));
        
        return result;
    }
    
    private double getZScore(double confidence) {
        if (confidence >= 0.99) return 2.326;
        if (confidence >= 0.95) return 1.645;
        if (confidence >= 0.90) return 1.282;
        return 1.0;
    }
    
    private double toDouble(Object obj) {
        if (obj == null) return 0.0;
        if (obj instanceof Number) return ((Number) obj).doubleValue();
        return Double.parseDouble(obj.toString());
    }
}</div>
        
        <p class="mt-4"><strong>DAG Configuration:</strong></p>
        <div class="code-block json">{
  "name": "risk_calculation_dag",
  "nodes": [
    {
      "id": "positions",
      "type": "SubscriptionNode",
      "subscribers": [{"uri": "kafka://risk:positions"}]
    },
    {
      "id": "var_calc",
      "type": "CalculationNode",
      "calculator": "java",
      "java_class": "com.trading.risk.VaRCalculator",
      "confidence_level": 0.99,
      "lookback_days": 252
    },
    {
      "id": "output",
      "type": "PublicationNode",
      "publishers": [{"uri": "kafka://risk:var_results"}]
    }
  ],
  "edges": [
    {"from": "positions", "to": "var_calc"},
    {"from": "var_calc", "to": "output"}
  ]
}</div>

        <h6 class="mt-5">Example 2: High-Frequency Math Processing</h6>
        
        <p><strong>Java Code:</strong></p>
        <div class="code-block java">package com.hft.math;

import com.dishtayantra.calculators.AbstractCalculator;
import java.util.Map;
import java.util.HashMap;

public class MovingAverageCalculator extends AbstractCalculator {
    
    private final int windowSize;
    private final double[] window;
    private int index = 0;
    private boolean windowFull = false;
    
    public MovingAverageCalculator(String name, Map&lt;String, Object&gt; config) {
        super(name, config);
        this.windowSize = getConfig("window_size", 20);
        this.window = new double[windowSize];
    }
    
    @Override
    protected synchronized Map&lt;String, Object&gt; doCalculate(Map&lt;String, Object&gt; data) {
        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;(data);
        
        double value = toDouble(data.get("price"));
        
        // Add to window
        window[index] = value;
        index = (index + 1) % windowSize;
        if (index == 0) windowFull = true;
        
        // Calculate moving average
        int count = windowFull ? windowSize : index;
        double sum = 0;
        for (int i = 0; i < count; i++) {
            sum += window[i];
        }
        double ma = sum / count;
        
        result.put("moving_avg", ma);
        result.put("window_size", count);
        
        return result;
    }
    
    private double toDouble(Object obj) {
        if (obj instanceof Number) return ((Number) obj).doubleValue();
        return Double.parseDouble(obj.toString());
    }
}</div>
    </div>
</div>

<!-- Beating Spark -->
<div class="card mb-4" id="beating-spark">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-trophy"></i> Beating Spark for Real-Time Calculations</h5>
    </div>
    <div class="card-body">
        <p>DishtaYantra with Java calculators can outperform Spark for real-time, low-latency scenarios:</p>
        
        <table class="table table-bordered vs-table">
            <thead>
                <tr>
                    <th>Aspect</th>
                    <th>Apache Spark</th>
                    <th>DishtaYantra + Java</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Latency</strong></td>
                    <td>100ms - 1s (micro-batch)</td>
                    <td><span class="badge bg-success">&lt;10ms per record</span></td>
                </tr>
                <tr>
                    <td><strong>Setup Overhead</strong></td>
                    <td>Cluster required</td>
                    <td><span class="badge bg-success">Single process</span></td>
                </tr>
                <tr>
                    <td><strong>Memory Footprint</strong></td>
                    <td>GBs per executor</td>
                    <td><span class="badge bg-success">100s of MBs</span></td>
                </tr>
                <tr>
                    <td><strong>Cold Start</strong></td>
                    <td>30-60 seconds</td>
                    <td><span class="badge bg-success">&lt;1 second</span></td>
                </tr>
                <tr>
                    <td><strong>Record-by-Record</strong></td>
                    <td>Inefficient</td>
                    <td><span class="badge bg-success">Optimized</span></td>
                </tr>
                <tr>
                    <td><strong>State Management</strong></td>
                    <td>Complex</td>
                    <td><span class="badge bg-success">Simple</span></td>
                </tr>
            </tbody>
        </table>
        
        <div class="performance-card">
            <h5><i class="bi bi-graph-up-arrow"></i> Real-World Benchmarks</h5>
            <div class="performance-metric">
                <span class="metric-label">Trade pricing (1M trades/day)</span>
                <span class="metric-value">DishtaYantra 8x faster</span>
            </div>
            <div class="performance-metric">
                <span class="metric-label">Risk calculation (100K positions)</span>
                <span class="metric-value">DishtaYantra 12x faster</span>
            </div>
            <div class="performance-metric">
                <span class="metric-label">P99 latency</span>
                <span class="metric-value">DishtaYantra &lt;5ms vs Spark 500ms</span>
            </div>
            <div class="performance-metric">
                <span class="metric-label">Infrastructure cost</span>
                <span class="metric-value">DishtaYantra 70% lower</span>
            </div>
        </div>
        
        <div class="tip-box">
            <strong><i class="bi bi-trophy"></i> When DishtaYantra Wins:</strong>
            <ul class="mb-0 mt-2">
                <li>Real-time, record-by-record processing</li>
                <li>Sub-10ms latency requirements</li>
                <li>Stateful calculations with persistence</li>
                <li>Complex routing and branching logic</li>
                <li>Hybrid Python/Java workloads</li>
            </ul>
        </div>
        
        <div class="warning-box">
            <strong><i class="bi bi-info-circle"></i> When Spark is Better:</strong>
            <ul class="mb-0 mt-2">
                <li>Batch processing of massive datasets (TBs+)</li>
                <li>SQL-heavy analytics</li>
                <li>Machine learning pipelines (MLlib)</li>
                <li>When latency >1 second is acceptable</li>
            </ul>
        </div>
    </div>
</div>

<!-- Troubleshooting -->
<div class="card mb-4" id="troubleshooting">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-bug"></i> Troubleshooting</h5>
    </div>
    <div class="card-body">
        <h6>Issue: "Py4J is not installed"</h6>
        <div class="code-block bash">pip install py4j</div>
        
        <h6 class="mt-4">Issue: Connection Refused</h6>
        <p>Ensure the Java gateway server is running:</p>
        <div class="code-block bash"># Check if gateway is running
netstat -an | grep 25333

# Start gateway
java -cp "dishtayantra-calculators.jar:py4j-0.10.9.7.jar" \
    com.dishtayantra.gateway.DishtaYantraGateway</div>
        
        <h6 class="mt-4">Issue: Class Not Found</h6>
        <p>Ensure your calculator class is in the classpath:</p>
        <div class="code-block bash"># Add your JAR to classpath
java -cp "your-calculators.jar:dishtayantra-calculators.jar:py4j-0.10.9.7.jar" \
    com.dishtayantra.gateway.DishtaYantraGateway</div>
        
        <h6 class="mt-4">Issue: Poor Performance</h6>
        <ul>
            <li>Increase gateway pool size to match thread count</li>
            <li>Use multiple JVM processes for true parallelism</li>
            <li>Profile Java code for hotspots</li>
            <li>Reduce data conversion overhead by keeping data structures simple</li>
        </ul>
        
        <h6 class="mt-4">Issue: Memory Leaks</h6>
        <ul>
            <li>Ensure Java calculators don't hold references to old data</li>
            <li>Monitor JVM heap with <code>jstat</code> or <code>jvisualvm</code></li>
            <li>Consider using thread-local instances for stateful calculators</li>
        </ul>
    </div>
</div>

<!-- Summary -->
<div class="card mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #f89820, #e07d10); color: white;">
        <h5 class="mb-0"><i class="bi bi-cup-hot-fill"></i> Summary</h5>
    </div>
    <div class="card-body">
        <table class="table table-bordered">
            <tbody>
                <tr>
                    <td width="30%"><strong>Technology</strong></td>
                    <td>Py4J bridge between Python and Java</td>
                </tr>
                <tr>
                    <td><strong>Performance</strong></td>
                    <td>10-100x faster than Python for CPU-intensive calculations</td>
                </tr>
                <tr>
                    <td><strong>Use Cases</strong></td>
                    <td>Risk analytics, pricing, high-frequency processing</td>
                </tr>
                <tr>
                    <td><strong>Configuration</strong></td>
                    <td>Set <code>calculator: "java"</code> and <code>java_class</code> in DAG config</td>
                </tr>
                <tr>
                    <td><strong>High Performance</strong></td>
                    <td>Gateway pooling for parallel execution across threads</td>
                </tr>
            </tbody>
        </table>
        
        <div class="tip-box">
            <strong><i class="bi bi-rocket"></i> Pro Tip:</strong> Combine Java calculators with Python's free-threading (Python 3.13+) for maximum parallelism - true multi-core execution on both the Python and Java sides!
        </div>
    </div>
</div>
{% endblock %}
