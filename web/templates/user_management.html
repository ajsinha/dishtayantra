{% extends "base.html" %}

{% block title %}User Management - DishtaYantra Compute Server{% endblock %}

{% block extra_css %}
<style>
    .user-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .stat-card {
        text-align: center;
        padding: 15px;
    }
    .stat-value {
        font-size: 2em;
        font-weight: bold;
    }
    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
    .admin-controls {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .role-badge {
        font-size: 0.85em;
        margin-right: 5px;
    }
    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
    }
    .sortable:hover {
        background-color: #e9ecef;
    }
    .sortable::after {
        content: '⇅';
        position: absolute;
        right: 8px;
        opacity: 0.3;
        font-size: 12px;
    }
    .sortable.asc::after {
        content: '↑';
        opacity: 1;
    }
    .sortable.desc::after {
        content: '↓';
        opacity: 1;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    .empty-state i {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-people"></i> User Management</h2>
            <div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- User Statistics -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="user-stats">
            <div class="row" id="statsRow">
                <div class="col-md-3 stat-card">
                    <div class="stat-value" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="col-md-3 stat-card">
                    <div class="stat-value" id="adminCount">-</div>
                    <div class="stat-label">Administrators</div>
                </div>
                <div class="col-md-3 stat-card">
                    <div class="stat-value" id="operatorCount">-</div>
                    <div class="stat-label">Operators</div>
                </div>
                <div class="col-md-3 stat-card">
                    <div class="stat-value" id="userCount">-</div>
                    <div class="stat-label">Regular Users</div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12 text-center">
                    <button class="btn btn-light btn-sm" onclick="loadStats(); loadUsers();" title="Refresh data">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Controls -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="admin-controls">
            <h5><i class="bi bi-shield-lock"></i> Admin Controls</h5>
            <div class="row">
                <div class="col-md-12">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        <i class="bi bi-plus-circle"></i> Create User
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Users</h5>
                <div class="table-controls">
                    <label class="mb-0 me-2">Show:</label>
                    <select id="pageSize" class="form-select form-select-sm" style="width: auto;" onchange="updateTable()">
                        <option value="10" selected>10</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">All</option>
                    </select>
                    <label class="mb-0 ms-3 me-2">Search:</label>
                    <input type="text" id="searchInput" class="form-control form-control-sm" style="width: 200px;" placeholder="Search users..." onkeyup="filterUsers()">
                </div>
            </div>
            <div class="card-body">
                <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="bi bi-inbox"></i>
                    <h4>No users found</h4>
                    <p>Start by creating a new user.</p>
                </div>

                <div id="tableContainer">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="sortable" data-sort="username" style="width: 20%;">Username</th>
                                    <th class="sortable" data-sort="full_name" style="width: 25%;">Full Name</th>
                                    <th class="sortable" data-sort="roles" style="width: 25%;">Roles</th>
                                    <th style="width: 15%;">Created</th>
                                    <th style="width: 15%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="tableInfo" class="text-muted">Showing 0 to 0 of 0 entries</div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnFirst" onclick="goToPage(1)" disabled>
                                <i class="bi bi-chevron-bar-left"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnPrev" onclick="goToPage(currentPage - 1)" disabled>
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" disabled>
                                <span id="pageInfo">Page 0 of 0</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnNext" onclick="goToPage(currentPage + 1)" disabled>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnLast" onclick="goToPage(totalPages)" disabled>
                                <i class="bi bi-chevron-bar-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label for="createUsername" class="form-label">Username *</label>
                        <input type="text" class="form-control" id="createUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="createPassword" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="createPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="createFullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="createFullName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Roles *</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="user" id="createRoleUser" checked>
                            <label class="form-check-label" for="createRoleUser">User</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="operator" id="createRoleOperator">
                            <label class="form-check-label" for="createRoleOperator">Operator</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="admin" id="createRoleAdmin">
                            <label class="form-check-label" for="createRoleAdmin">Administrator</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUsername">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsernameDisplay" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="editPassword">
                    </div>
                    <div class="mb-3">
                        <label for="editFullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="editFullName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Roles *</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="user" id="editRoleUser">
                            <label class="form-check-label" for="editRoleUser">User</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="operator" id="editRoleOperator">
                            <label class="form-check-label" for="editRoleOperator">Operator</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="admin" id="editRoleAdmin">
                            <label class="form-check-label" for="editRoleAdmin">Administrator</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">Update User</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let allUsers = [];
let filteredUsers = [];
let currentPage = 1;
let pageSize = 10;
let totalPages = 1;
let sortColumn = 'username';
let sortDirection = 'asc';

// Load statistics
function loadStats() {
    fetch('/users/api/stats', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('totalUsers').textContent = data.stats.total_users;
            document.getElementById('adminCount').textContent = data.stats.role_counts.admin || 0;
            document.getElementById('operatorCount').textContent = data.stats.role_counts.operator || 0;
            document.getElementById('userCount').textContent = data.stats.role_counts.user || 0;
        } else {
            showAlert('Error loading stats: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error loading stats: ' + error.message, 'danger');
    });
}

// Load users
function loadUsers() {
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('tableContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';

    fetch('/users/api/list', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingSpinner').style.display = 'none';

        if (data.success) {
            allUsers = data.users;
            filteredUsers = allUsers.slice();

            if (allUsers.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            } else {
                document.getElementById('tableContainer').style.display = 'block';
                sortUsers();
                updateTable();
            }
        } else {
            showAlert('Error loading users: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        document.getElementById('loadingSpinner').style.display = 'none';
        showAlert('Error loading users: ' + error.message, 'danger');
    });
}

// Sort users
function sortUsers() {
    filteredUsers.sort((a, b) => {
        let aVal = a[sortColumn] || '';
        let bVal = b[sortColumn] || '';

        if (sortColumn === 'roles') {
            aVal = aVal.join(',');
            bVal = bVal.join(',');
        }

        if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }

        if (sortDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
}

// Filter users
function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    if (searchTerm === '') {
        filteredUsers = allUsers.slice();
    } else {
        filteredUsers = allUsers.filter(user =>
            user.username.toLowerCase().includes(searchTerm) ||
            (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
            (user.roles && user.roles.some(role => role.toLowerCase().includes(searchTerm)))
        );
    }

    currentPage = 1;
    sortUsers();
    updateTable();
}

// Update table display
function updateTable() {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';

    // Calculate pagination
    const pageSizeValue = document.getElementById('pageSize').value;
    pageSize = pageSizeValue === 'all' ? filteredUsers.length : parseInt(pageSizeValue);
    totalPages = Math.ceil(filteredUsers.length / pageSize) || 1;

    if (currentPage > totalPages) {
        currentPage = totalPages;
    }

    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredUsers.length);
    const pageUsers = filteredUsers.slice(startIndex, endIndex);

    // Populate table
    pageUsers.forEach(user => {
        const row = document.createElement('tr');

        // Username
        const usernameCell = document.createElement('td');
        usernameCell.textContent = user.username;
        row.appendChild(usernameCell);

        // Full Name
        const fullNameCell = document.createElement('td');
        fullNameCell.textContent = user.full_name || user.username;
        row.appendChild(fullNameCell);

        // Roles
        const rolesCell = document.createElement('td');
        if (user.roles && user.roles.length > 0) {
            user.roles.forEach(role => {
                const badge = document.createElement('span');
                badge.className = `badge role-badge ${
                    role === 'admin' ? 'bg-danger' :
                    role === 'operator' ? 'bg-warning text-dark' :
                    'bg-secondary'
                }`;
                badge.textContent = role;
                rolesCell.appendChild(badge);
            });
        }
        row.appendChild(rolesCell);

        // Created
        const createdCell = document.createElement('td');
        if (user.created_at) {
            const date = new Date(user.created_at);
            createdCell.textContent = date.toLocaleDateString();
            createdCell.title = date.toLocaleString();
        } else {
            createdCell.textContent = '-';
        }
        row.appendChild(createdCell);

        // Actions
        const actionsCell = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-primary me-1';
        editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.title = 'Edit user';
        editBtn.onclick = () => showEditModal(user);
        actionsCell.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-danger';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        deleteBtn.title = 'Delete user';
        deleteBtn.onclick = () => deleteUser(user.username);
        actionsCell.appendChild(deleteBtn);

        row.appendChild(actionsCell);
        tbody.appendChild(row);
    });

    // Update pagination info
    document.getElementById('tableInfo').textContent =
        `Showing ${startIndex + 1} to ${endIndex} of ${filteredUsers.length} entries${
            filteredUsers.length < allUsers.length ? ` (filtered from ${allUsers.length} total)` : ''
        }`;

    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

    // Update pagination buttons
    document.getElementById('btnFirst').disabled = currentPage === 1 || pageSizeValue === 'all';
    document.getElementById('btnPrev').disabled = currentPage === 1 || pageSizeValue === 'all';
    document.getElementById('btnNext').disabled = currentPage === totalPages || pageSizeValue === 'all';
    document.getElementById('btnLast').disabled = currentPage === totalPages || pageSizeValue === 'all';

    // Update sort indicators
    document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.sort === sortColumn) {
            th.classList.add(sortDirection);
        }
    });
}

// Pagination
function goToPage(page) {
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateTable();
    }
}

// Show edit modal
function showEditModal(user) {
    document.getElementById('editUsername').value = user.username;
    document.getElementById('editUsernameDisplay').value = user.username;
    document.getElementById('editPassword').value = '';
    document.getElementById('editFullName').value = user.full_name || '';

    // Set roles
    document.getElementById('editRoleUser').checked = user.roles.includes('user');
    document.getElementById('editRoleOperator').checked = user.roles.includes('operator');
    document.getElementById('editRoleAdmin').checked = user.roles.includes('admin');

    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

// Create user
function createUser() {
    const username = document.getElementById('createUsername').value.trim();
    const password = document.getElementById('createPassword').value.trim();
    const fullName = document.getElementById('createFullName').value.trim();

    const roles = [];
    if (document.getElementById('createRoleUser').checked) roles.push('user');
    if (document.getElementById('createRoleOperator').checked) roles.push('operator');
    if (document.getElementById('createRoleAdmin').checked) roles.push('admin');

    if (!username) {
        showAlert('Username is required', 'warning');
        return;
    }

    if (!password) {
        showAlert('Password is required', 'warning');
        return;
    }

    if (roles.length === 0) {
        showAlert('At least one role is required', 'warning');
        return;
    }

    fetch('/users/api/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({username, password, full_name: fullName, roles})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
            document.getElementById('createUserForm').reset();
            document.getElementById('createRoleUser').checked = true;
            loadStats();
            loadUsers();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error creating user: ' + error.message, 'danger');
    });
}

// Update user
function updateUser() {
    const username = document.getElementById('editUsername').value;
    const password = document.getElementById('editPassword').value.trim();
    const fullName = document.getElementById('editFullName').value.trim();

    const roles = [];
    if (document.getElementById('editRoleUser').checked) roles.push('user');
    if (document.getElementById('editRoleOperator').checked) roles.push('operator');
    if (document.getElementById('editRoleAdmin').checked) roles.push('admin');

    if (roles.length === 0) {
        showAlert('At least one role is required', 'warning');
        return;
    }

    const data = {username, full_name: fullName, roles};
    if (password) {
        data.password = password;
    }

    fetch('/users/api/update', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            loadStats();
            loadUsers();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error updating user: ' + error.message, 'danger');
    });
}

// Delete user
function deleteUser(username) {
    if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone.`)) {
        return;
    }

    fetch('/users/api/delete', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({username})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadStats();
            loadUsers();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error deleting user: ' + error.message, 'danger');
    });
}

// Show alert
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const flashContainer = document.querySelector('.flash-messages');
    flashContainer.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Setup table sorting
document.querySelectorAll('.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const column = this.dataset.sort;
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }
        sortUsers();
        updateTable();
    });
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadUsers();
});
</script>
{% endblock %}