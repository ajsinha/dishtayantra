{% extends "base.html" %}

{% block title %}User Management - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .user-stats {
        background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #1e3a5f 100%);
        color: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(30, 58, 95, 0.3);
    }
    .stat-card {
        text-align: center;
        padding: 15px;
    }
    .stat-value {
        font-size: 2.4em;
        font-weight: 400;
        color: #00d4aa;
        line-height: 1.2;
    }
    .stat-label {
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 400;
        color: #00d4aa;
        margin-top: 8px;
    }
    .admin-controls {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-left: 4px solid #f59e0b;
        border-radius: 8px;
        padding: 18px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
    }
    .admin-controls h5 {
        color: #92400e;
        margin-bottom: 12px;
    }
    .role-badge {
        font-size: 0.8em;
        margin-right: 5px;
        padding: 0.4em 0.8em;
        font-weight: 600;
    }
    .table-controls {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
    }
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 24px !important;
        transition: background 0.2s ease;
    }
    .sortable:hover {
        background-color: #e2e8f0 !important;
    }
    .sortable::after {
        content: '⇅';
        position: absolute;
        right: 10px;
        opacity: 0.3;
        font-size: 12px;
    }
    .sortable.asc::after {
        content: '↑';
        opacity: 1;
        color: var(--primary-dark, #1e3a5f);
    }
    .sortable.desc::after {
        content: '↓';
        opacity: 1;
        color: var(--primary-dark, #1e3a5f);
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }
    .empty-state i {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.3;
        color: var(--primary-light, #4a90c2);
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e2e8f0;
    }
    .page-header h2 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .page-header h2 i {
        color: var(--primary-light, #4a90c2);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-people"></i> User Management</h2>
            <div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- User Statistics -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="user-stats">
            <div class="row" id="statsRow">
                <div class="col-md-3 stat-card">
                    <div class="stat-value" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="col-md-3 stat-card">
                    <div class="stat-value" id="adminCount">-</div>
                    <div class="stat-label">Administrators</div>
                </div>
                <div class="col-md-3 stat-card">
                    <div class="stat-value" id="operatorCount">-</div>
                    <div class="stat-label">Operators</div>
                </div>
                <div class="col-md-3 stat-card">
                    <div class="stat-value" id="userCount">-</div>
                    <div class="stat-label">Regular Users</div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12 text-center">
                    <button class="btn btn-light btn-sm" onclick="refreshUsers();" title="Refresh data from file">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Controls -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="admin-controls">
            <h5><i class="bi bi-shield-lock"></i> Admin Controls</h5>
            <div class="row">
                <div class="col-md-12">
                    <a href="{{ url_for('user_create_page') }}" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Create User
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Users</h5>
                <div class="table-controls">
                    <label class="mb-0 me-2">Show:</label>
                    <select id="pageSize" class="form-select form-select-sm" style="width: auto;" onchange="updateTable()">
                        <option value="10" selected>10</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">All</option>
                    </select>
                    <label class="mb-0 ms-3 me-2">Search:</label>
                    <input type="text" id="searchInput" class="form-control form-control-sm" style="width: 200px;" placeholder="Search users..." onkeyup="filterUsers()">
                </div>
            </div>
            <div class="card-body">
                <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="bi bi-inbox"></i>
                    <h4>No users found</h4>
                    <p>Start by creating a new user.</p>
                </div>

                <div id="tableContainer">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="username" style="width: 20%;">Username</th>
                                    <th class="sortable" data-sort="full_name" style="width: 25%;">Full Name</th>
                                    <th class="sortable" data-sort="roles" style="width: 25%;">Roles</th>
                                    <th style="width: 15%;">Created</th>
                                    <th style="width: 15%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="tableInfo" class="text-muted">Showing 0 to 0 of 0 entries</div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnFirst" onclick="goToPage(1)" disabled>
                                <i class="bi bi-chevron-bar-left"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnPrev" onclick="goToPage(currentPage - 1)" disabled>
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" disabled>
                                <span id="pageInfo">Page 0 of 0</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnNext" onclick="goToPage(currentPage + 1)" disabled>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnLast" onclick="goToPage(totalPages)" disabled>
                                <i class="bi bi-chevron-bar-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let allUsers = [];
let filteredUsers = [];
let currentPage = 1;
let pageSize = 10;
let totalPages = 1;
let sortColumn = 'username';
let sortDirection = 'asc';

// Load statistics
function loadStats() {
    fetch('/users/api/stats', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('totalUsers').textContent = data.stats.total_users;
            document.getElementById('adminCount').textContent = data.stats.role_counts.admin || 0;
            document.getElementById('operatorCount').textContent = data.stats.role_counts.operator || 0;
            document.getElementById('userCount').textContent = data.stats.role_counts.user || 0;
        } else {
            showAlert('Error loading stats: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error loading stats: ' + error.message, 'danger');
    });
}

// Refresh users from file
function refreshUsers() {
    // Show loading indicator
    showAlert('Reloading users from file...', 'info');

    // Call reload endpoint first
    fetch('/users/api/reload', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Now reload the UI data
            loadStats();
            loadUsers();
        } else {
            showAlert('Error reloading users: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error reloading users: ' + error.message, 'danger');
    });
}

// Load users
function loadUsers() {
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('tableContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';

    fetch('/users/api/list', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingSpinner').style.display = 'none';

        if (data.success) {
            allUsers = data.users;
            filteredUsers = allUsers.slice();

            if (allUsers.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            } else {
                document.getElementById('tableContainer').style.display = 'block';
                sortUsers();
                updateTable();
            }
        } else {
            showAlert('Error loading users: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        document.getElementById('loadingSpinner').style.display = 'none';
        showAlert('Error loading users: ' + error.message, 'danger');
    });
}

// Sort users
function sortUsers() {
    filteredUsers.sort((a, b) => {
        let aVal = a[sortColumn] || '';
        let bVal = b[sortColumn] || '';

        if (sortColumn === 'roles') {
            aVal = aVal.join(',');
            bVal = bVal.join(',');
        }

        if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }

        if (sortDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
}

// Filter users
function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    if (searchTerm === '') {
        filteredUsers = allUsers.slice();
    } else {
        filteredUsers = allUsers.filter(user =>
            user.username.toLowerCase().includes(searchTerm) ||
            (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
            (user.roles && user.roles.some(role => role.toLowerCase().includes(searchTerm)))
        );
    }

    currentPage = 1;
    sortUsers();
    updateTable();
}

// Update table display
function updateTable() {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';

    // Calculate pagination
    const pageSizeValue = document.getElementById('pageSize').value;
    pageSize = pageSizeValue === 'all' ? filteredUsers.length : parseInt(pageSizeValue);
    totalPages = Math.ceil(filteredUsers.length / pageSize) || 1;

    if (currentPage > totalPages) {
        currentPage = totalPages;
    }

    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredUsers.length);
    const pageUsers = filteredUsers.slice(startIndex, endIndex);

    // Populate table
    pageUsers.forEach(user => {
        const row = document.createElement('tr');

        // Username
        const usernameCell = document.createElement('td');
        usernameCell.textContent = user.username;
        row.appendChild(usernameCell);

        // Full Name
        const fullNameCell = document.createElement('td');
        fullNameCell.textContent = user.full_name || user.username;
        row.appendChild(fullNameCell);

        // Roles
        const rolesCell = document.createElement('td');
        if (user.roles && user.roles.length > 0) {
            user.roles.forEach(role => {
                const badge = document.createElement('span');
                badge.className = `badge role-badge ${
                    role === 'admin' ? 'bg-danger' :
                    role === 'operator' ? 'bg-warning text-dark' :
                    'bg-secondary'
                }`;
                badge.textContent = role;
                rolesCell.appendChild(badge);
            });
        }
        row.appendChild(rolesCell);

        // Created
        const createdCell = document.createElement('td');
        if (user.created_at) {
            const date = new Date(user.created_at);
            createdCell.textContent = date.toLocaleDateString();
            createdCell.title = date.toLocaleString();
        } else {
            createdCell.textContent = '-';
        }
        row.appendChild(createdCell);

        // Actions
        const actionsCell = document.createElement('td');

        // Check if this is the protected admin user
        const isAdminUser = user.username.toLowerCase() === 'admin';

        const editBtn = document.createElement('a');
        editBtn.className = 'btn btn-sm btn-primary me-1';
        editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.title = isAdminUser ? 'Cannot edit protected admin user' : 'Edit user';

        if (isAdminUser) {
            editBtn.classList.add('disabled');
            editBtn.style.pointerEvents = 'none';
            editBtn.style.opacity = '0.5';
        } else {
            editBtn.href = `/users/edit/${user.username}`;
        }

        actionsCell.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-danger';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        deleteBtn.title = isAdminUser ? 'Cannot delete protected admin user' : 'Delete user';

        if (isAdminUser) {
            deleteBtn.disabled = true;
            deleteBtn.style.opacity = '0.5';
        } else {
            deleteBtn.onclick = () => deleteUser(user.username);
        }

        actionsCell.appendChild(deleteBtn);

        row.appendChild(actionsCell);
        tbody.appendChild(row);
    });

    // Update pagination info
    document.getElementById('tableInfo').textContent =
        `Showing ${startIndex + 1} to ${endIndex} of ${filteredUsers.length} entries${
            filteredUsers.length < allUsers.length ? ` (filtered from ${allUsers.length} total)` : ''
        }`;

    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

    // Update pagination buttons
    document.getElementById('btnFirst').disabled = currentPage === 1 || pageSizeValue === 'all';
    document.getElementById('btnPrev').disabled = currentPage === 1 || pageSizeValue === 'all';
    document.getElementById('btnNext').disabled = currentPage === totalPages || pageSizeValue === 'all';
    document.getElementById('btnLast').disabled = currentPage === totalPages || pageSizeValue === 'all';

    // Update sort indicators
    document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.sort === sortColumn) {
            th.classList.add(sortDirection);
        }
    });
}

// Pagination
function goToPage(page) {
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateTable();
    }
}

// Delete user
function deleteUser(username) {
    if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone.`)) {
        return;
    }

    fetch('/users/api/delete', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({username})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadStats();
            loadUsers();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error deleting user: ' + error.message, 'danger');
    });
}

// Show alert
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const flashContainer = document.querySelector('.flash-messages');
    flashContainer.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Setup table sorting
document.querySelectorAll('.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const column = this.dataset.sort;
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }
        sortUsers();
        updateTable();
    });
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadUsers();
});
</script>
{% endblock %}